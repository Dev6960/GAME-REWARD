<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
<title id="pageTitle">GAME REWARD</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, orderBy, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD7ePIu7x4KbojvUD47DWSKbuqH5nzE5uc",
            authDomain: "laafi-bf.firebaseapp.com",
            projectId: "laafi-bf",
            storageBucket: "laafi-bf.firebasestorage.app",
            messagingSenderId: "837012050847",
            appId: "1:837012050847:web:f7eae39f1a985b3596e3aa",
            measurementId: "G-W6HHK2WTVF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseFunctions = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            doc,
            setDoc,
            getDoc,
            updateDoc,
            collection,
            getDocs,
            orderBy,
            query,
            where,
            writeBatch
        };
        
        console.log("Firebase initialisé avec succès!");
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
            color: #FFD700;
        }
        
        .logo h1 {
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .user-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .language-selector {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #FFD700;
            color: #333;
        }
        
        .btn-primary:hover {
            background: #FFC400;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .game-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #FFD700;
        }
        
        .info-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        #gameCanvas {
            background: #0a0e2a;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 800px;
        }
        
        .game-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-btn {
            padding: 12px 25px;
            font-size: 1rem;
        }
        
        .touch-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 300px;
            margin-top: 20px;
            padding: 0 20px;
        }
        
        .control-arrow {
            width: 60px;
            height: 60px;
            font-size: 24px;
            background: rgba(255, 215, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .control-arrow:active {
            background: rgba(255, 215, 0, 1);
            transform: scale(0.95);
        }
        
        .stats-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .token-display {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .token-count {
            font-size: 3rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            margin: 10px 0;
        }
        
        .token-label {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .recover-section {
            text-align: center;
            margin: 20px 0;
            position: sticky;
            bottom: 20px;
            z-index: 100;
            background: rgba(26, 42, 108, 0.9);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .recover-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .recover-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.6);
        }
        
        .recover-btn:disabled {
            background: #9E9E9E;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .recover-message {
            margin-top: 15px;
            padding: 10px;
            background: rgba(76, 175, 80, 0.2);
            border-radius: 5px;
            display: none;
        }
        
        .withdraw-section {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: rgba(76, 175, 80, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .withdraw-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
            font-weight: bold;
        }
        
        .withdraw-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.6);
        }
        
        .withdraw-btn:disabled {
            background: #9E9E9E;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .withdraw-message {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            display: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #FFD700;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .leaderboard {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-top: 30px;
        }
        
        .leaderboard h2 {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .leaderboard-item:first-child {
            background: rgba(255, 215, 0, 0.3);
        }
        
        .leaderboard-rank {
            font-weight: bold;
            margin-right: 10px;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        
        .tab.active {
            opacity: 1;
            border-bottom: 2px solid #FFD700;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }
        
        .username-feedback {
            font-size: 0.8rem;
            margin-top: 5px;
            height: 20px;
        }
        
        .username-available {
            color: #4CAF50;
        }
        
        .username-taken {
            color: #f44336;
        }
        
        .modal-btn {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: #FFD700;
            color: #333;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }
        
        .modal-btn:hover {
            background: #FFC400;
        }
        
        .user-panel {
            display: none;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-name {
            font-weight: bold;
        }
        
        .user-level {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        /* Game Over Screen */
        .game-over {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            padding: 20px;
        }
        
        .game-over-content {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        }
        
        .game-over h2 {
            font-size: 3rem;
            color: #FFD700;
            margin-bottom: 20px;
        }
        
        .game-over p {
            font-size: 1.5rem;
            margin-bottom: 30px;
        }
        
        .game-over-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .game-over-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .restart-btn {
            background: #FFD700;
            color: #333;
        }
        
        .restart-btn:hover {
            background: #FFC400;
            transform: translateY(-3px);
        }
        
        .recover-game-over-btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .recover-game-over-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .recover-game-over-btn:disabled {
            background: #9E9E9E;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Instructions */
        .instructions {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #FFD700;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 10px;
        }

        .error-message {
            color: #ff6b6b;
            text-align: center;
            margin-top: 10px;
            display: none;
        }
        
        .sponsor-info {
            background: rgba(255, 215, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }
        
        .sponsor-bonus {
            color: #4CAF50;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        /* Alert Modal Styles */
        .alert-body {
            text-align: center;
            padding: 20px;
        }

        .alert-body p {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        .success-alert {
            color: #4CAF50;
        }
        
        .warning-alert {
            color: #FF9800;
        }
        
        .error-alert {
            color: #f44336;
        }
        
        .referral-section {
            background: rgba(255, 215, 0, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .referral-code {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 1.2rem;
            text-align: center;
            border: 1px dashed #FFD700;
        }
        
        .copy-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .referral-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .referral-stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .referral-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #FFD700;
        }
        
        .no-tokens-message {
            background: rgba(255, 152, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid rgba(255, 152, 0, 0.5);
        }
        
        /* CORRECTIONS HEADER - À AJOUTER À LA FIN DU STYLE */
        .user-panel {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #authButtons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Fix pour l'ordre d'affichage */
        .user-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: nowrap;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .user-actions {
                flex-wrap: wrap;
                justify-content: flex-end;
            }
            
            .language-selector {
                order: 1;
            }
            
            #authButtons {
                order: 2;
                flex-wrap: wrap;
            }
        }
    </style>
    
</head>

<body>
	<script type="text/javascript">
	atOptions = {
		'key' : 'e1939b1b9610e5a9c495fffeabb659f8',
		'format' : 'iframe',
		'height' : 50,
		'width' : 320,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//robotbagpipe.com/e1939b1b9610e5a9c495fffeabb659f8/invoke.js"></script>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-gamepad"></i>
                <h1 id="appTitle">Brick Breaker</h1>
            </div>
            <div class="user-actions">
                <select class="language-selector" id="languageSelector">
                    <option value="fr">Français</option>
                    <option value="en">English</option>
                    <option value="es">Español</option>
                    <option value="de">Deutsch</option>
                </select>
                <div id="authButtons">
                    <button class="btn btn-primary" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i> <span id="loginText">Connexion</span>
                    </button>
                    <button class="btn btn-secondary" id="registerBtn">
                        <i class="fas fa-user-plus"></i> <span id="registerText">Inscription</span>
                    </button>
                </div>
                <div class="user-panel" id="userPanel">
                    <div class="user-info">
                        <div class="user-name" id="userName">Joueur</div>
                        <div class="user-level"><span id="tokensText">Argent</span>: <span id="userTokens">0</span></div>
                    </div>
                    <div class="avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <button class="btn btn-secondary" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>
<script type="text/javascript">
	atOptions = {
		'key' : 'e1939b1b9610e5a9c495fffeabb659f8',
		'format' : 'iframe',
		'height' : 50,
		'width' : 320,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//robotbagpipe.com/e1939b1b9610e5a9c495fffeabb659f8/invoke.js"></script>
        <div class="main-content">
            <section class="game-container">
                <div class="game-info">
                    <div class="info-item">
                        <div class="info-value" id="score">0</div>
                        <div class="info-label" id="scoreLabel">Score</div>
                    </div>
                    <div class="info-item">
                        <div class="info-value" id="level">1</div>
                        <div class="info-label" id="levelLabel">Niveau</div>
                    </div>
                    <div class="info-item">
                        <div class="info-value" id="lives">3</div>
                        <div class="info-label" id="livesLabel">Vies</div>
                    </div>
                </div>
                
                <canvas id="gameCanvas" width="800" height="500"></canvas>
                
                <div class="touch-controls">
                    <button class="control-arrow left-arrow" id="leftArrow">←</button>
                    <button class="control-arrow right-arrow" id="rightArrow">→</button>
                </div>
                
                <div class="game-controls">
                    <button class="btn btn-primary control-btn" id="startBtn">
                        <i class="fas fa-play"></i> <span id="startText">Commencer</span>
                    </button>
                    <button class="btn btn-secondary control-btn" id="pauseBtn">
                        <i class="fas fa-pause"></i> <span id="pauseText">Pause</span>
                    </button>
                    <button class="btn btn-secondary control-btn" id="resetBtn">
                        <i class="fas fa-redo"></i> <span id="resetText">Recommencer</span>
                    </button>
                </div>
                
                
                <div class="instructions">
                    <h3 id="howToPlayTitle">Comment jouer:</h3>
                    <ul>
                        <li id="instruction1">Utilisez les touches ← et → ou les boutons pour déplacer la raquette</li>
                        <li id="instruction2">Cassez toutes les briques pour passer au niveau suivant</li>
                        <li id="instruction3">Chaque brique cassée = 1 point = 0.05 €</li>
                        <li id="instruction4">Ajoutez votre argent au portefeuille après avoir joué pour rejouer</li>
                    </ul>
                </div>
                <script type="text/javascript">
	atOptions = {
		'key' : 'e1939b1b9610e5a9c495fffeabb659f8',
		'format' : 'iframe',
		'height' : 50,
		'width' : 320,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//robotbagpipe.com/e1939b1b9610e5a9c495fffeabb659f8/invoke.js"></script>
                
                
                <div class="game-over" id="gameOverScreen">
                    <div class="game-over-content">
                    	<script type="text/javascript">
	atOptions = {
		'key' : 'e1939b1b9610e5a9c495fffeabb659f8',
		'format' : 'iframe',
		'height' : 50,
		'width' : 320,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//robotbagpipe.com/e1939b1b9610e5a9c495fffeabb659f8/invoke.js"></script>
                        <h2 id="gameOverTitle">Partie Terminée</h2>
                        <p id="finalScoreText">Score final: <span id="finalScore">0</span></p>
                        <p id="tokensEarnedText">Argent gagné: <span id="tokensEarned">0</span> €</p>
                        
                        <div class="game-over-buttons">
                            <button class="game-over-btn restart-btn" id="restartBtn">
                                <i class="fas fa-redo"></i> <span id="playAgainText">Rejouer</span>
                            </button>
                            <button class="game-over-btn recover-game-over-btn" id="recoverGameOverBtn" disabled>
                                <i class="fas fa-gem"></i> <span id="recoverTokensText">Ajouter au Portefeuille</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="stats-area">
                <div class="token-display">
                    <div class="token-label" id="yourTokensText">Votre Argent</div>
                    <div class="token-count" id="tokenCount">0</div>
                    <div class="token-label" id="tokenRateText">1 brique = 1 point = 0.05 €</div>
                </div>
                
                <div class="recover-section">
                    <button class="recover-btn" id="recoverBtn" disabled>
                        <i class="fas fa-gem"></i> <span id="recoverButtonText">Ajouter au Portefeuille</span>
                    </button>
                    <div class="no-tokens-message" id="noTokensMessage" style="display: none;">
                        <i class="fas fa-info-circle"></i> <span id="noTokensText">Aucun argent à ajouter pour le moment</span>
                    </div>
                    <div class="recover-message" id="recoverMessage">
                        <i class="fas fa-check-circle"></i> <span id="recoverSuccessText">Argent ajouté au portefeuille avec succès!</span>
                    </div>
                </div>
                
                <div class="withdraw-section">
                    <button class="withdraw-btn" id="withdrawBtn">
                        <i class="fas fa-money-bill-wave"></i> 
                        <span id="withdrawButtonText">Retirer mes Gains</span>
                    </button>
                    <div class="withdraw-message" id="withdrawMessage">
                        <i class="fas fa-check-circle"></i> 
                        <span id="withdrawSuccessText">Redirection vers la page de retrait...</span>
                    </div>
                </div>
                
                <h2 id="gameStatsTitle">Statistiques de Jeu</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label" id="bestScoreLabel">Meilleur Score</div>
                        <div class="stat-value" id="bestScore">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" id="gamesPlayedLabel">Parties Jouées</div>
                        <div class="stat-value" id="gamesPlayed">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" id="tokensRecoveredLabel">Argent Récupéré</div>
                        <div class="stat-value" id="tokensRecovered">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" id="maxLevelLabel">Niveau Max</div>
                        <div class="stat-value" id="maxLevel">1</div>
                    </div>
                </div>
                
                <div class="sponsor-info" id="sponsorInfo" style="display: none;">
                    <h3><i class="fas fa-user-friends"></i> <span id="sponsorProgramTitle">Programme de Parrainage</span></h3>
                    <p id="yourSponsorText">Votre parrain: <span id="sponsorName">-</span></p>
                    <p id="sponsorBonusText">Votre parrain gagne 1 € + 5% de vos gains!</p>
</div>
                <script type="text/javascript">
	atOptions = {
		'key' : 'e1939b1b9610e5a9c495fffeabb659f8',
		'format' : 'iframe',
		'height' : 50,
		'width' : 320,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//robotbagpipe.com/e1939b1b9610e5a9c495fffeabb659f8/invoke.js"></script>
                
                <div class="referral-section" id="referralSection" style="display: none;">
                    <h3><i class="fas fa-share-alt"></i> <span id="yourReferralTitle">Votre Code de Parrainage</span></h3>
                    <div class="referral-code" id="referralCode">-</div>
                    <button class="copy-btn" id="copyReferralBtn">
                        <i class="fas fa-copy"></i> <span id="copyCodeText">Copier le code</span>
                    </button>
                    <p id="referralInfoText">Partagez ce code avec vos amis et gagnez 1 € + 5% de leurs gains!</p>
                    
                    <div class="referral-stats">
                        <div class="referral-stat">
                            <div class="referral-stat-value" id="referralCount">0</div>
                            <div class="stat-label" id="referralsLabel">Filleuls</div>
                        </div>
                        <div class="referral-stat">
                            <div class="referral-stat-value" id="referralEarnings">0</div>
                            <div class="stat-label" id="earningsLabel">Gains</div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <section class="leaderboard">
            <h2 id="leaderboardTitle">Classement des Joueurs</h2>
            <script type="text/javascript">
	atOptions = {
		'key' : 'e1939b1b9610e5a9c495fffeabb659f8',
		'format' : 'iframe',
		'height' : 50,
		'width' : 320,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//robotbagpipe.com/e1939b1b9610e5a9c495fffeabb659f8/invoke.js"></script>
            <div class="loading" id="leaderboardLoading">
                <i class="fas fa-spinner fa-spin"></i> <span id="loadingText">Chargement...</span>
            </div>
            <div id="leaderboardList">
                <!-- Le classement sera chargé dynamiquement -->
            </div>
        </section>
        
        <footer>
            <p id="footerText">GAME REWARD&copy; 2025 - 1 brique = 1 point = 0.05 €</p>
            <script type="text/javascript">
	atOptions = {
		'key' : 'e1939b1b9610e5a9c495fffeabb659f8',
		'format' : 'iframe',
		'height' : 50,
		'width' : 320,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//robotbagpipe.com/e1939b1b9610e5a9c495fffeabb659f8/invoke.js"></script>
        </footer>
    </div>
    <script async="async" data-cfasync="false" src="//robotbagpipe.com/d80a7a3d00e65b3cc8df8b810763df70/invoke.js"></script>
<div id="container-d80a7a3d00e65b3cc8df8b810763df70"></div>
    <!-- Modal de Connexion/Inscription -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <button class="close-modal" id="closeModal">&times;</button>
            <div class="modal-tabs">
                <div class="tab active" data-tab="login" id="loginTabText">Connexion</div>
                <div class="tab" data-tab="register" id="registerTabText">Inscription</div>
            </div>
            
            <div class="tab-content active" id="loginTab">
                <h2 id="loginTitle">Connexion</h2>
                <div class="form-group">
                    <label for="loginEmail" id="emailLabel">Email:</label>
                    <input type="email" id="loginEmail" placeholder="Votre adresse email">
                </div>
                <div class="form-group">
                    <label for="loginPassword" id="passwordLabel">Mot de passe:</label>
                    <input type="password" id="loginPassword" placeholder="Votre mot de passe">
                </div>
                <div class="error-message" id="loginError"></div>
                <button class="modal-btn" id="submitLogin">
                    <i class="fas fa-sign-in-alt"></i> <span id="connectText">Se connecter</span>
                </button>
            </div>
            
            <div class="tab-content" id="registerTab">
                <h2 id="registerTitle">Inscription</h2>
                <div class="form-group">
                    <label for="registerUsername" id="usernameLabel">Nom d'utilisateur:</label>
                    <input type="text" id="registerUsername" placeholder="Choisissez un nom unique">
                    <div class="username-feedback" id="usernameFeedback"></div>
                </div>
                <div class="form-group">
                    <label for="registerEmail" id="emailLabel2">Email:</label>
                    <input type="email" id="registerEmail" placeholder="Votre adresse email">
                </div>
                <div class="form-group">
                    <label for="registerPassword" id="passwordLabel2">Mot de passe:</label>
                    <input type="password" id="registerPassword" placeholder="Créez un mot de passe (min. 6 caractères)">
                </div>
                <div class="form-group">
                    <label for="confirmPassword" id="confirmPasswordLabel">Confirmer le mot de passe:</label>
                    <input type="password" id="confirmPassword" placeholder="Confirmez votre mot de passe">
                </div>
                <div class="form-group">
                    <label for="sponsorUsername" id="sponsorLabel">Nom du parrain (optionnel):</label>
                    <input type="text" id="sponsorUsername" placeholder="Username de votre parrain">
                    <div class="username-feedback" id="sponsorFeedback"></div>
                    <div class="sponsor-bonus">
                        <i class="fas fa-gift"></i> <span id="bonusText">Bonus: 1 € offert avec un code parrain!</span>
                    </div>
                </div>
                <div class="error-message" id="registerError"></div>
                <button class="modal-btn" id="submitRegister">
                    <i class="fas fa-user-plus"></i> <span id="createAccountText">Créer un compte</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal d'alerte -->
    <div class="modal" id="alertModal">
        <div class="modal-content">
            <div class="alert-body">
                <p id="alertMessage"></p>
                <button class="modal-btn" id="closeAlert">OK</button>
            </div>
        </div>
    </div>

<script>
    // Variables globales
    let tokens = 0;
    let tokensEarned = 0;
    let tokensRecovered = 0;
    let bestScore = 0;
    let gamesPlayed = 0;
    let maxLevel = 1;
    let userLoggedIn = false;
    let currentUser = null;
    let currentUserData = null;
    let currentLanguage = 'fr';
    
    // Variables du jeu
    let canvas, ctx;
    let gameRunning = false;
    let gamePaused = false;
    let score = 0;
    let level = 1;
    let lives = 3;
    
    // Éléments du jeu
    let paddle, ball, bricks = [];
    
    // Éléments DOM
    const tokenCountElement = document.getElementById('tokenCount');
    const scoreElement = document.getElementById('score');
    const levelElement = document.getElementById('level');
    const livesElement = document.getElementById('lives');
    const recoverBtn = document.getElementById('recoverBtn');
    const noTokensMessage = document.getElementById('noTokensMessage');
    const recoverMessage = document.getElementById('recoverMessage');
    const bestScoreElement = document.getElementById('bestScore');
    const gamesPlayedElement = document.getElementById('gamesPlayed');
    const tokensRecoveredElement = document.getElementById('tokensRecovered');
    const maxLevelElement = document.getElementById('maxLevel');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const finalScoreElement = document.getElementById('finalScore');
    const tokensEarnedElement = document.getElementById('tokensEarned');
    const restartBtn = document.getElementById('restartBtn');
    const recoverGameOverBtn = document.getElementById('recoverGameOverBtn');
    const authModal = document.getElementById('authModal');
    const closeModal = document.getElementById('closeModal');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const submitLogin = document.getElementById('submitLogin');
    const submitRegister = document.getElementById('submitRegister');
    const authButtons = document.getElementById('authButtons');
    const userPanel = document.getElementById('userPanel');
    const userNameElement = document.getElementById('userName');
    const userTokensElement = document.getElementById('userTokens');
    const logoutBtn = document.getElementById('logoutBtn');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const loginError = document.getElementById('loginError');
    const registerError = document.getElementById('registerError');
    const leaderboardList = document.getElementById('leaderboardList');
    const leaderboardLoading = document.getElementById('leaderboardLoading');
    const leftArrow = document.getElementById('leftArrow');
    const rightArrow = document.getElementById('rightArrow');
    const registerUsername = document.getElementById('registerUsername');
    const usernameFeedback = document.getElementById('usernameFeedback');
    const sponsorUsername = document.getElementById('sponsorUsername');
    const sponsorFeedback = document.getElementById('sponsorFeedback');
    const sponsorInfo = document.getElementById('sponsorInfo');
    const sponsorName = document.getElementById('sponsorName');
    const alertModal = document.getElementById('alertModal');
    const alertMessage = document.getElementById('alertMessage');
    const closeAlert = document.getElementById('closeAlert');
    const languageSelector = document.getElementById('languageSelector');
    const referralSection = document.getElementById('referralSection');
    const referralCode = document.getElementById('referralCode');
    const copyReferralBtn = document.getElementById('copyReferralBtn');
    const referralCount = document.getElementById('referralCount');
    const referralEarnings = document.getElementById('referralEarnings');
    const withdrawBtn = document.getElementById('withdrawBtn');
    const withdrawMessage = document.getElementById('withdrawMessage');

    // Dictionnaire de traduction
    const translations = {
        fr: {
            appTitle: "GAME REWARD",
            loginText: "Connexion",
            registerText: "Inscription",
            tokensText: "Argent",
            scoreLabel: "Score",
            levelLabel: "Niveau",
            livesLabel: "Vies",
            startText: "Commencer",
            pauseText: "Pause",
            resetText: "Recommencer",
            howToPlayTitle: "Comment jouer:",
            instruction1: "Utilisez les touches ← et → ou les boutons pour déplacer la raquette",
            instruction2: "Cassez toutes les briques pour passer au niveau suivant",
            instruction3: "Chaque brique cassée = 1 point = 0.05 €",
            instruction4: "Ajoutez votre argent au portefeuille après avoir joué pour rejouer",
            gameOverTitle: "Partie Terminée",
            finalScoreText: "Score final:",
            tokensEarnedText: "Argent gagné:",
            playAgainText: "Rejouer",
            recoverTokensText: "Ajouter au Portefeuille",
            yourTokensText: "Votre Argent",
            tokenRateText: "1 brique = 1 point = 0.05 €",
            recoverButtonText: "Ajouter au Portefeuille",
            noTokensText: "Aucun argent à ajouter pour le moment",
            recoverSuccessText: "Argent ajouté au portefeuille avec succès!",
            withdrawButtonText: "Retirer mes Gains",
            withdrawSuccessText: "Redirection vers la page de retrait...",
            gameStatsTitle: "Statistiques de Jeu",
            bestScoreLabel: "Meilleur Score",
            gamesPlayedLabel: "Parties Jouées",
            tokensRecoveredLabel: "Argent Récupéré",
            maxLevelLabel: "Niveau Max",
            sponsorProgramTitle: "Programme de Parrainage",
            yourSponsorText: "Votre parrain:",
            sponsorBonusText: "Votre parrain gagne 1 € + 5% de vos gains!",
            yourReferralTitle: "Votre Code de Parrainage",
            copyCodeText: "Copier le code",
            referralInfoText: "Partagez ce code avec vos amis et gagnez 1 € + 5% de leurs gains!",
            referralsLabel: "Filleuls",
            earningsLabel: "Gains",
            leaderboardTitle: "Classement par Argent Gagné",
            loadingText: "Chargement...",
            footerText: "GAME REWARD &copy; 2025 - 1 brique = 1 point = 0.05 €",
            loginTabText: "Connexion",
            registerTabText: "Inscription",
            loginTitle: "Connexion",
            emailLabel: "Email:",
            passwordLabel: "Mot de passe:",
            connectText: "Se connecter",
            registerTitle: "Inscription",
            usernameLabel: "Nom d'utilisateur:",
            emailLabel2: "Email:",
            passwordLabel2: "Mot de passe:",
            confirmPasswordLabel: "Confirmer le mot de passe:",
            sponsorLabel: "Nom du parrain (optionnel):",
            bonusText: "Bonus: 1 € offert avec un code parrain!",
            createAccountText: "Créer un compte",
            noTokensAlert: "Aucun argent à ajouter pour le moment!",
            mustRecoverAlert: "Vous devez ajouter votre argent au portefeuille avant de rejouer!",
            registerSuccess: "Compte créé avec succès! Bienvenue sur GAME REWARD!",
            loginSuccess: "Connexion réussie! Bienvenue ",
            logoutSuccess: "Vous avez été déconnecté!",
            tokensRecoveredAlert: "Argent ajouté au portefeuille avec succès!",
            noMoneyAlert: "Aucun argent disponible pour le retrait!"
        },
        en: {
            appTitle: "GAME REWARD",
            loginText: "Login",
            registerText: "Register",
            tokensText: "Money",
            scoreLabel: "Score",
            levelLabel: "Level",
            livesLabel: "Lives",
            startText: "Start",
            pauseText: "Pause",
            resetText: "Restart",
            howToPlayTitle: "How to play:",
            instruction1: "Use ← and → keys or buttons to move the paddle",
            instruction2: "Break all bricks to advance to the next level",
            instruction3: "Each brick broken = 1 point = 0.05 €",
            instruction4: "Add your money to wallet after playing to play again",
            gameOverTitle: "Game Over",
            finalScoreText: "Final score:",
            tokensEarnedText: "Money earned:",
            playAgainText: "Play Again",
            recoverTokensText: "Add to Wallet",
            yourTokensText: "Your Money",
            tokenRateText: "1 brick = 1 point = 0.05 €",
            recoverButtonText: "Add to Wallet",
            noTokensText: "No money to add at the moment",
            recoverSuccessText: "Money added to wallet successfully!",
            withdrawButtonText: "Withdraw Earnings",
            withdrawSuccessText: "Redirecting to withdrawal page...",
            gameStatsTitle: "Game Statistics",
            bestScoreLabel: "Best Score",
            gamesPlayedLabel: "Games Played",
            tokensRecoveredLabel: "Money Recovered",
            maxLevelLabel: "Max Level",
            sponsorProgramTitle: "Referral Program",
            yourSponsorText: "Your sponsor:",
            sponsorBonusText: "Your sponsor earns 1 € + 5% of your earnings!",
            yourReferralTitle: "Your Referral Code",
            copyCodeText: "Copy code",
            referralInfoText: "Share this code with your friends and earn 1 € + 5% of their earnings!",
            referralsLabel: "Referrals",
            earningsLabel: "Earnings",
            leaderboardTitle: "Money Leaderboard",
            loadingText: "Loading...",
            footerText: "GAME REWARD &copy; 2025 - 1 brick = 1 point = 0.05 €",
            loginTabText: "Login",
            registerTabText: "Register",
            loginTitle: "Login",
            emailLabel: "Email:",
            passwordLabel: "Password:",
            connectText: "Sign In",
            registerTitle: "Register",
            usernameLabel: "Username:",
            emailLabel2: "Email:",
            passwordLabel2: "Password:",
            confirmPasswordLabel: "Confirm Password:",
            sponsorLabel: "Sponsor username (optional):",
            bonusText: "Bonus: 1 € free with a sponsor code!",
            createAccountText: "Create Account",
            noTokensAlert: "No money to add at the moment!",
            mustRecoverAlert: "You must add your money to wallet before playing again!",
            registerSuccess: "Account created successfully! Welcome to GAME REWARD!",
            loginSuccess: "Login successful! Welcome ",
            logoutSuccess: "You have been logged out!",
            tokensRecoveredAlert: "Money added to wallet successfully!",
            noMoneyAlert: "No money available for withdrawal!"
        },
        es: {
            appTitle: "GAME REWARD",
            loginText: "Iniciar Sesión",
            registerText: "Registrarse",
            tokensText: "Dinero",
            scoreLabel: "Puntuación",
            levelLabel: "Nivel",
            livesLabel: "Vidas",
            startText: "Comenzar",
            pauseText: "Pausa",
            resetText: "Reiniciar",
            howToPlayTitle: "Cómo jugar:",
            instruction1: "Usa las teclas ← y → o los botones para mover la paleta",
            instruction2: "Rompe todos los ladrillos para pasar al siguiente nivel",
            instruction3: "Cada ladrillo roto = 1 punto = 0.05 €",
            instruction4: "Añade tu dinero a la cartera después de jugar para volver a jugar",
            gameOverTitle: "Juego Terminado",
            finalScoreText: "Puntuación final:",
            tokensEarnedText: "Dinero ganado:",
            playAgainText: "Jugar Otra Vez",
            recoverTokensText: "Añadir a Cartera",
            yourTokensText: "Tu Dinero",
            tokenRateText: "1 ladrillo = 1 punto = 0.05 €",
            recoverButtonText: "Añadir a Cartera",
            noTokensText: "No hay dinero para añadir en este momento",
            recoverSuccessText: "¡Dinero añadido a la cartera con éxito!",
            withdrawButtonText: "Retirar Ganancias",
            withdrawSuccessText: "Redirigiendo a la página de retiro...",
            gameStatsTitle: "Estadísticas del Juego",
            bestScoreLabel: "Mejor Puntuación",
            gamesPlayedLabel: "Partidas Jugadas",
            tokensRecoveredLabel: "Dinero Recuperado",
            maxLevelLabel: "Nivel Máximo",
            sponsorProgramTitle: "Programa de Referidos",
            yourSponsorText: "Tu patrocinador:",
            sponsorBonusText: "¡Tu patrocinador gana 1 € + 5% de tus ganancias!",
            yourReferralTitle: "Tu Código de Referido",
            copyCodeText: "Copiar código",
            referralInfoText: "¡Comparte este código con tus amigos y gana 1 € + 5% de sus ganancias!",
            referralsLabel: "Referidos",
            earningsLabel: "Ganancias",
            leaderboardTitle: "Clasificación por Dinero",
            loadingText: "Cargando...",
            footerText: "GAME REWARD &copy; 2025 - 1 ladrillo = 1 punto = 0.05 €",
            loginTabText: "Iniciar Sesión",
            registerTabText: "Registrarse",
            loginTitle: "Iniciar Sesión",
            emailLabel: "Email:",
            passwordLabel: "Contraseña:",
            connectText: "Iniciar Sesión",
            registerTitle: "Registrarse",
            usernameLabel: "Nombre de usuario:",
            emailLabel2: "Email:",
            passwordLabel2: "Contraseña:",
            confirmPasswordLabel: "Confirmar Contraseña:",
            sponsorLabel: "Nombre del patrocinador (opcional):",
            bonusText: "¡Bonus: 1 € gratis con código de patrocinador!",
            createAccountText: "Crear Cuenta",
            noTokensAlert: "¡No hay dinero para añadir en este momento!",
            mustRecoverAlert: "¡Debes añadir tu dinero a la cartera antes de volver a jugar!",
            registerSuccess: "¡Cuenta creada con éxito! Bienvenido a GAME REWARD!",
            loginSuccess: "¡Inicio de sesión exitoso! Bienvenido ",
            logoutSuccess: "¡Has cerrado sesión!",
            tokensRecoveredAlert: "¡Dinero añadido a la cartera con éxito!",
            noMoneyAlert: "¡No hay dinero disponible para retirar!"
        },
        de: {
            appTitle: "GAME REWARD",
            loginText: "Anmelden",
            registerText: "Registrieren",
            tokensText: "Geld",
            scoreLabel: "Punkte",
            levelLabel: "Level",
            livesLabel: "Leben",
            startText: "Starten",
            pauseText: "Pause",
            resetText: "Neustart",
            howToPlayTitle: "Spielanleitung:",
            instruction1: "Verwende ← und → Tasten oder Buttons, um das Paddel zu bewegen",
            instruction2: "Zerstöre alle Steine, um zum nächsten Level zu gelangen",
            instruction3: "Jeder zerstörte Stein = 1 Punkt = 0.05 €",
            instruction4: "Füge dein Geld der Brieftasche hinzu, um erneut zu spielen",
            gameOverTitle: "Spiel Beendet",
            finalScoreText: "Endpunktzahl:",
            tokensEarnedText: "Erhaltenes Geld:",
            playAgainText: "Nochmal Spielen",
            recoverTokensText: "Zur Brieftasche Hinzufügen",
            yourTokensText: "Dein Geld",
            tokenRateText: "1 Stein = 1 Punkt = 0.05 €",
            recoverButtonText: "Zur Brieftasche Hinzufügen",
            noTokensText: "Derzeit kein Geld zum Hinzufügen verfügbar",
            recoverSuccessText: "Geld erfolgreich zur Brieftasche hinzugefügt!",
            withdrawButtonText: "Gewinne Abheben",
            withdrawSuccessText: "Weiterleitung zur Auszahlungsseite...",
            gameStatsTitle: "Spielstatistiken",
            bestScoreLabel: "Beste Punktzahl",
            gamesPlayedLabel: "Gespielte Spiele",
            tokensRecoveredLabel: "Wiederhergestelltes Geld",
            maxLevelLabel: "Max Level",
            sponsorProgramTitle: "Partnerprogramm",
            yourSponsorText: "Dein Sponsor:",
            sponsorBonusText: "Dein Sponsor erhält 1 € + 5% deiner Einnahmen!",
            yourReferralTitle: "Dein Empfehlungscode",
            copyCodeText: "Code kopieren",
            referralInfoText: "Teile diesen Code mit deinen Freunden und verdiene 1 € + 5% ihrer Einnahmen!",
            referralsLabel: "Empfehlungen",
            earningsLabel: "Einnahmen",
            leaderboardTitle: "Geld Bestenliste",
            loadingText: "Lädt...",
            footerText: "GAME REWARD &copy; 2025 - 1 Stein = 1 Punkt = 0.05 €",
            loginTabText: "Anmelden",
            registerTabText: "Registrieren",
            loginTitle: "Anmelden",
            emailLabel: "Email:",
            passwordLabel: "Passwort:",
            connectText: "Anmelden",
            registerTitle: "Registrieren",
            usernameLabel: "Benutzername:",
            emailLabel2: "Email:",
            passwordLabel2: "Passwort:",
            confirmPasswordLabel: "Passwort bestätigen:",
            sponsorLabel: "Sponsor Benutzername (optional):",
            bonusText: "Bonus: 1 € kostenlos mit einem Sponsor-Code!",
            createAccountText: "Konto Erstellen",
            noTokensAlert: "Derzeit kein Geld zum Hinzufügen verfügbar!",
            mustRecoverAlert: "Du musst dein Geld zur Brieftasche hinzufügen, bevor du erneut spielen kannst!",
            registerSuccess: "Konto erfolgreich erstellt! Willkommen bei GAME REWARD!",
            loginSuccess: "Anmeldung erfolgreich! Willkommen ",
            logoutSuccess: "Du wurdest abgemeldet!",
            tokensRecoveredAlert: "Geld erfolgreich zur Brieftasche hinzugefügt!",
            noMoneyAlert: "Kein Geld für Auszahlung verfügbar!"
        }
    };

    // Initialisation Firebase
    let auth, db;
    let firebaseFunctions;

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // Détecter la langue de l'utilisateur
        detectUserLanguage();
        
        // Attendre que Firebase soit chargé
        setTimeout(initializeApp, 100);
    });

    function detectUserLanguage() {
        const browserLang = navigator.language || navigator.userLanguage;
        const langCode = browserLang.split('-')[0];
        
        if (translations[langCode]) {
            currentLanguage = langCode;
        } else {
            currentLanguage = 'fr'; // Français par défaut
        }
        
        languageSelector.value = currentLanguage;
        updateLanguage();
    }

    function updateLanguage() {
        const lang = translations[currentLanguage];
        
        // Mettre à jour tous les textes
        document.querySelectorAll('[id]').forEach(element => {
            const id = element.id;
            if (lang[id]) {
                if (element.tagName === 'INPUT' && element.type !== 'button') {
                    element.placeholder = lang[id];
                } else {
                    element.textContent = lang[id];
                }
            }
        });
        
        // Mettre à jour le titre de la page
        document.title = lang.appTitle;
    }

    function initializeApp() {
        auth = window.firebaseAuth;
        db = window.firebaseDb;
        firebaseFunctions = window.firebaseFunctions;

        if (!auth || !db) {
            console.error("Firebase n'est pas initialisé correctement");
            return;
        }

        // Initialiser le canvas
        canvas = document.getElementById('gameCanvas');
        ctx = canvas.getContext('2d');
        
        // Surveiller l'état d'authentification
        firebaseFunctions.onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userLoggedIn = true;
                loadUserData();
                updateUI();
                loadLeaderboard();
            } else {
                currentUser = null;
                userLoggedIn = false;
                updateUI();
            }
        });
        
        // Initialiser le jeu
        initGame();
        
        // Événements de contrôle
        document.addEventListener('keydown', keyDownHandler);
        document.addEventListener('keyup', keyUpHandler);
        
        // Événements des boutons
        startBtn.addEventListener('click', startGame);
        pauseBtn.addEventListener('click', togglePause);
        resetBtn.addEventListener('click', resetGame);
        restartBtn.addEventListener('click', restartGame);
        recoverBtn.addEventListener('click', recoverTokens);
        recoverGameOverBtn.addEventListener('click', recoverTokensFromGameOver);
        withdrawBtn.addEventListener('click', withdrawEarnings);
        
        // Événements des flèches tactiles
        leftArrow.addEventListener('mousedown', () => paddle.dx = -paddle.speed);
        leftArrow.addEventListener('mouseup', () => paddle.dx = 0);
        leftArrow.addEventListener('touchstart', () => paddle.dx = -paddle.speed);
        leftArrow.addEventListener('touchend', () => paddle.dx = 0);
        
        rightArrow.addEventListener('mousedown', () => paddle.dx = paddle.speed);
        rightArrow.addEventListener('mouseup', () => paddle.dx = 0);
        rightArrow.addEventListener('touchstart', () => paddle.dx = paddle.speed);
        rightArrow.addEventListener('touchend', () => paddle.dx = 0);
        
        // Événements d'authentification
        loginBtn.addEventListener('click', showAuthModal);
        registerBtn.addEventListener('click', showAuthModal);
        closeModal.addEventListener('click', closeAuthModal);
        submitLogin.addEventListener('click', submitLoginForm);
        submitRegister.addEventListener('click', submitRegisterForm);
        logoutBtn.addEventListener('click', logoutUser);
        
        // Événement de changement de langue
        languageSelector.addEventListener('change', function() {
            currentLanguage = this.value;
            updateLanguage();
        });
        
        // Événement de copie du code de parrainage
        copyReferralBtn.addEventListener('click', copyReferralCode);
        
        // Vérification du nom d'utilisateur en temps réel
        registerUsername.addEventListener('input', checkUsernameAvailability);
        sponsorUsername.addEventListener('input', checkSponsorExistence);
        
        // Événement pour fermer l'alerte
        closeAlert.addEventListener('click', () => {
            alertModal.style.display = 'none';
        });
        
        // Changer d'onglet dans la modal
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Désactiver tous les onglets
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                // Activer l'onglet sélectionné
                this.classList.add('active');
                document.getElementById(tabId + 'Tab').classList.add('active');
            });
        });
        
        // Désactiver le défilement avec les flèches
        disableArrowKeyScrolling();
        
        // Boucle de jeu
        requestAnimationFrame(gameLoop);
    }

    // Fonction pour déclencher l'URL de récupération
    function triggerTokenRecovery() {
        // Ouvrir l'URL dans un nouvel onglet
        window.open('https://robotbagpipe.com/yxg22edmt5?key=ebf623286659a485611ac6e4071ab1c1', '_blank');
    }

    // Système d'alerte modal
    function showModalAlert(message, type = 'info') {
        alertMessage.textContent = message;
        
        // Appliquer une classe selon le type d'alerte
        alertMessage.className = '';
        if (type === 'success') {
            alertMessage.classList.add('success-alert');
        } else if (type === 'warning') {
            alertMessage.classList.add('warning-alert');
        } else if (type === 'error') {
            alertMessage.classList.add('error-alert');
        }
        
        alertModal.style.display = 'flex';
    }

    // Fonctions de défilement
    function scrollToRecoverButton() {
        const recoverSection = document.querySelector('.recover-section');
        recoverSection.scrollIntoView({ 
            behavior: 'smooth',
            block: 'center'
        });
    }

    function scrollToGame() {
        const gameContainer = document.querySelector('.game-container');
        gameContainer.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
    }

    // Fonction pour copier le code de parrainage
    function copyReferralCode() {
        const code = referralCode.textContent;
        navigator.clipboard.writeText(code).then(() => {
            showModalAlert(translations[currentLanguage].copyCodeText + ' copié!', 'success');
        });
    }

    // Désactiver le défilement avec les flèches
    function disableArrowKeyScrolling() {
        window.addEventListener("keydown", function(e) {
            // Empêcher le défilement avec les flèches
            if(["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code)) {
                e.preventDefault();
            }
        }, false);
    }

    // Fonction de retrait
    function withdrawEarnings() {
        if (tokensRecovered > 0) {
            // Afficher le message de succès
            withdrawMessage.style.display = 'block';
            
            // Rediriger vers la page de retrait après un court délai
            setTimeout(() => {
                window.location.href = 'retrait.html';
            }, 1500);
            
            // Masquer le message après 3 secondes
            setTimeout(() => {
                withdrawMessage.style.display = 'none';
            }, 3000);
        } else {
            showModalAlert(translations[currentLanguage].noMoneyAlert, 'warning');
        }
    }

    // Initialisation du jeu
    function initGame() {
        // Créer la raquette
        paddle = {
            x: canvas.width / 2 - 50,
            y: canvas.height - 20,
            width: 100,
            height: 10,
            speed: 8,
            dx: 0
        };
        
        // Créer la balle
        ball = {
            x: canvas.width / 2,
            y: canvas.height - 30,
            radius: 8,
            speed: 5,
            dx: 5,
            dy: -5
        };
        
        // Créer les briques
        createBricks();
    }
    
    // Créer les briques
    function createBricks() {
        bricks = [];
        const brickRows = 5;
        const brickCols = 10;
        const brickWidth = 70;
        const brickHeight = 20;
        const brickPadding = 5;
        const brickOffsetTop = 50;
        const brickOffsetLeft = 20;
        
        for (let r = 0; r < brickRows; r++) {
            for (let c = 0; c < brickCols; c++) {
                const brickX = c * (brickWidth + brickPadding) + brickOffsetLeft;
                const brickY = r * (brickHeight + brickPadding) + brickOffsetTop;
                
                // Couleur différente selon la ligne
                let color;
                if (r === 0) color = '#FF5252';
                else if (r === 1) color = '#FF9800';
                else if (r === 2) color = '#FFEB3B';
                else if (r === 3) color = '#4CAF50';
                else color = '#2196F3';
                
                bricks.push({
                    x: brickX,
                    y: brickY,
                    width: brickWidth,
                    height: brickHeight,
                    color: color,
                    visible: true
                });
            }
        }
    }
    
    // Dessiner la raquette
    function drawPaddle() {
        ctx.beginPath();
        ctx.rect(paddle.x, paddle.y, paddle.width, paddle.height);
        ctx.fillStyle = '#FFD700';
        ctx.fill();
        ctx.closePath();
    }
    
    // Dessiner la balle
    function drawBall() {
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
        ctx.fillStyle = '#FFFFFF';
        ctx.fill();
        ctx.closePath();
    }
    
    // Dessiner les briques
    function drawBricks() {
        bricks.forEach(brick => {
            if (brick.visible) {
                ctx.beginPath();
                ctx.rect(brick.x, brick.y, brick.width, brick.height);
                ctx.fillStyle = brick.color;
                ctx.fill();
                ctx.closePath();
            }
        });
    }
    
    // Dessiner le jeu
    function draw() {
        // Effacer le canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Dessiner les éléments
        drawBricks();
        drawPaddle();
        drawBall();
        
        // Dessiner les informations de jeu si en pause
        if (gamePaused) {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.font = '40px Arial';
            ctx.fillStyle = '#FFD700';
            ctx.textAlign = 'center';
            ctx.fillText('PAUSE', canvas.width / 2, canvas.height / 2);
        }
    }
    
    // Mettre à jour le jeu
    function update() {
        if (gamePaused || !gameRunning) return;
        
        // Déplacer la raquette
        paddle.x += paddle.dx;
        
        // Empêcher la raquette de sortir de l'écran
        if (paddle.x < 0) {
            paddle.x = 0;
        } else if (paddle.x + paddle.width > canvas.width) {
            paddle.x = canvas.width - paddle.width;
        }
        
        // Déplacer la balle
        ball.x += ball.dx;
        ball.y += ball.dy;
        
        // Collision avec les murs
        if (ball.x + ball.radius > canvas.width || ball.x - ball.radius < 0) {
            ball.dx = -ball.dx;
        }
        
        // Collision avec le plafond
        if (ball.y - ball.radius < 0) {
            ball.dy = -ball.dy;
        }
        
        // Collision avec la raquette
        if (
            ball.y + ball.radius > paddle.y &&
            ball.x > paddle.x &&
            ball.x < paddle.x + paddle.width
        ) {
            ball.dy = -ball.dy;
            
            // Ajuster la direction en fonction de l'endroit où la balle touche la raquette
            const hitPoint = (ball.x - (paddle.x + paddle.width / 2)) / (paddle.width / 2);
            ball.dx = hitPoint * 7;
        }
        
        // Collision avec le sol (perdre une vie)
        if (ball.y + ball.radius > canvas.height) {
            lives--;
            livesElement.textContent = lives;
            
            if (lives <= 0) {
                gameOver();
            } else {
                resetBall();
            }
        }
        
        // Collision avec les briques
        bricks.forEach(brick => {
            if (brick.visible) {
                if (
                    ball.x + ball.radius > brick.x &&
                    ball.x - ball.radius < brick.x + brick.width &&
                    ball.y + ball.radius > brick.y &&
                    ball.y - ball.radius < brick.y + brick.height
                ) {
                    ball.dy = -ball.dy;
                    brick.visible = false;
                    
                    // Augmenter le score (1 point par brique)
                    score += 1;
                    scoreElement.textContent = score;
                    
                    // Vérifier si toutes les briques sont cassées
                    if (bricks.every(b => !b.visible)) {
                        levelUp();
                    }
                }
            }
        });
    }
    
    // Réinitialiser la balle
    function resetBall() {
        ball.x = canvas.width / 2;
        ball.y = canvas.height - 30;
        ball.dx = 5 * (Math.random() > 0.5 ? 1 : -1);
        ball.dy = -5;
    }
    
    // Passer au niveau suivant
    function levelUp() {
        level++;
        levelElement.textContent = level;
        
        if (level > maxLevel) {
            maxLevel = level;
            maxLevelElement.textContent = maxLevel;
        }
        
        // Réinitialiser la balle et les briques
        resetBall();
        createBricks();
        
        // Augmenter la vitesse de la balle
        ball.speed += 0.5;
        ball.dx = ball.dx > 0 ? ball.speed : -ball.speed;
        ball.dy = ball.dy > 0 ? ball.speed : -ball.speed;
    }
    
    // Game Over
    function gameOver() {
        gameRunning = false;
        gamesPlayed++;
        gamesPlayedElement.textContent = gamesPlayed;
        
        // Calculer l'argent gagné (1 point = 0.05 €)
        tokensEarned = score * 0.05;
        tokens += tokensEarned;
        
        // Mettre à jour le meilleur score
        if (score > bestScore) {
            bestScore = score;
            bestScoreElement.textContent = bestScore;
        }
        
        // Traiter les récompenses du parrain
        if (currentUser && currentUserData && currentUserData.sponsor) {
            handleSponsorRewards(currentUserData.sponsor, tokensEarned);
        }
        
        // AFFICHER LES VALEURS DANS L'ÉCRAN DE FIN
        finalScoreElement.textContent = score;
        tokensEarnedElement.textContent = tokensEarned.toFixed(2);
        gameOverScreen.style.display = 'flex';
        
        // Activer les boutons de récupération seulement s'il y a de l'argent
        const hasTokens = tokens > 0;
        recoverBtn.disabled = !hasTokens;
        recoverGameOverBtn.disabled = !hasTokens;
        
        // Désactiver le bouton de démarrage si l'utilisateur a de l'argent non récupéré
        startBtn.disabled = hasTokens;
        
        // METTRE À JOUR L'AFFICHAGE DE L'ARGENT IMMÉDIATEMENT
        updateTokenDisplay();
        
        // Sauvegarder les données utilisateur
        saveUserData();
    }
    
    // Boucle de jeu
    function gameLoop() {
        draw();
        update();
        requestAnimationFrame(gameLoop);
    }
    
    // Gestionnaires d'événements clavier
    function keyDownHandler(e) {
        if (e.key === 'Right' || e.key === 'ArrowRight') {
            paddle.dx = paddle.speed;
        } else if (e.key === 'Left' || e.key === 'ArrowLeft') {
            paddle.dx = -paddle.speed;
        }
    }
    
    function keyUpHandler(e) {
        if (e.key === 'Right' || e.key === 'ArrowRight' || e.key === 'Left' || e.key === 'ArrowLeft') {
            paddle.dx = 0;
        }
    }
    
    // Contrôles du jeu
    function startGame() {
        if (!userLoggedIn) {
            showAuthModal();
            return;
        }
        
        // Vérifier si l'utilisateur a de l'argent non récupéré
        if (tokens > 0) {
            showModalAlert(translations[currentLanguage].mustRecoverAlert, 'warning');
            scrollToRecoverButton();
            return;
        }
        
        gameRunning = true;
        gamePaused = false;
        startBtn.disabled = true;
    }
    
    function togglePause() {
        if (!gameRunning) return;
        gamePaused = !gamePaused;
    }
    
    function resetGame() {
        score = 0;
        level = 1;
        lives = 3;
        
        scoreElement.textContent = score;
        levelElement.textContent = level;
        livesElement.textContent = lives;
        
        gameRunning = false;
        gamePaused = false;
        startBtn.disabled = false;
        gameOverScreen.style.display = 'none';
        
        initGame();
    }
    
    function restartGame() {
        resetGame();
        startGame();
    }
    
    // Récupérer l'argent
    function recoverTokens() {
        if (tokens > 0) {
            // Déclencher l'URL automatiquement
            triggerTokenRecovery();
            
            // AJOUTER L'ARGENT À L'ARGENT RÉCUPÉRÉ
            tokensRecovered += tokens;
            
            // Réinitialiser l'argent pour permettre de rejouer
            tokens = 0;
            tokensEarned = 0;
            
            updateTokenDisplay();
            recoverBtn.disabled = true;
            recoverGameOverBtn.disabled = true;
            
            // Masquer le message "aucun argent" et afficher le message de succès
            noTokensMessage.style.display = 'none';
            recoverMessage.style.display = 'block';
            
            // Réactiver le bouton de démarrage
            startBtn.disabled = false;
            
            // Afficher le message de confirmation dans une modal
            showModalAlert(translations[currentLanguage].tokensRecoveredAlert, 'success');
            
            saveUserData();
            
            // Faire défiler vers le jeu
            setTimeout(scrollToGame, 1000);
            
            // Masquer le message de succès après 3 secondes
            setTimeout(() => {
                recoverMessage.style.display = 'none';
            }, 3000);
        } else {
            // Afficher le message "aucun argent à ajouter"
            noTokensMessage.style.display = 'block';
            recoverMessage.style.display = 'none';
            
            // Masquer le message après 3 secondes
            setTimeout(() => {
                noTokensMessage.style.display = 'none';
            }, 3000);
        }
    }
    
    // Récupérer l'argent depuis l'écran de fin de partie
    function recoverTokensFromGameOver() {
        if (tokens > 0) {
            recoverTokens();
            // Masquer l'écran de fin de partie après récupération
            gameOverScreen.style.display = 'none';
        } else {
            showModalAlert(translations[currentLanguage].noTokensAlert, 'warning');
        }
    }
    
    // Mettre à jour l'affichage de l'argent
    function updateTokenDisplay() {
        // Dans l'en-tête, on affiche l'argent total récupéré
        userTokensElement.textContent = tokensRecovered.toFixed(2);
        
        // Dans la section statistiques, on affiche l'argent non récupéré
        tokenCountElement.textContent = tokens.toFixed(2);
        
        // Mettre à jour l'état des boutons
        const hasTokens = tokens > 0;
        const hasMoney = tokensRecovered > 0;
        
        recoverBtn.disabled = !hasTokens;
        recoverGameOverBtn.disabled = !hasTokens;
        withdrawBtn.disabled = !hasMoney;
        
        // Afficher ou masquer le message "aucun argent"
        if (!hasTokens) {
            noTokensMessage.style.display = 'block';
            recoverMessage.style.display = 'none';
        } else {
            noTokensMessage.style.display = 'none';
        }
        
        // METTRE À JOUR LE BOUTON DE DÉMARRAGE
        startBtn.disabled = hasTokens;
        
        // METTRE À JOUR L'AFFICHAGE DE L'ARGENT RÉCUPÉRÉ DANS LES STATISTIQUES
        tokensRecoveredElement.textContent = tokensRecovered.toFixed(2);
    }
    
    // Système d'authentification Firebase
    function showAuthModal() {
        authModal.style.display = 'flex';
        loginError.style.display = 'none';
        registerError.style.display = 'none';
    }
    
    function closeAuthModal() {
        authModal.style.display = 'none';
        // Réinitialiser les formulaires
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';
        document.getElementById('registerEmail').value = '';
        document.getElementById('registerPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        document.getElementById('registerUsername').value = '';
        document.getElementById('sponsorUsername').value = '';
        usernameFeedback.textContent = '';
        sponsorFeedback.textContent = '';
    }
    
    async function submitLoginForm() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        if (!email || !password) {
            showError(loginError, 'Veuillez remplir tous les champs!');
            return;
        }
        
        try {
            const userCredential = await firebaseFunctions.signInWithEmailAndPassword(auth, email, password);
            closeAuthModal();
            showModalAlert(translations[currentLanguage].loginSuccess + email + '!', 'success');
        } catch (error) {
            showError(loginError, getAuthErrorMessage(error.code));
        }
    }
    
    async function submitRegisterForm() {
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const username = document.getElementById('registerUsername').value;
        const sponsor = document.getElementById('sponsorUsername').value;
        
        if (!email || !password || !confirmPassword || !username) {
            showError(registerError, 'Veuillez remplir tous les champs obligatoires!');
            return;
        }
        
        if (password !== confirmPassword) {
            showError(registerError, 'Les mots de passe ne correspondent pas!');
            return;
        }
        
        if (password.length < 6) {
            showError(registerError, 'Le mot de passe doit contenir au moins 6 caractères');
            return;
        }
        
        if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
            showError(registerError, 'Le nom d\'utilisateur doit contenir entre 3 et 20 caractères (lettres, chiffres et underscores)');
            return;
        }
        
        // Vérifier si le nom d'utilisateur est disponible
        const isUsernameAvailable = await checkUsernameUnique(username);
        if (!isUsernameAvailable) {
            showError(registerError, 'Ce nom d\'utilisateur est déjà pris!');
            return;
        }
        
        // Vérifier si le parrain existe (seulement si un parrain est spécifié)
        if (sponsor && sponsor.trim() !== '') {
            const sponsorExists = await checkSponsorExists(sponsor);
            if (!sponsorExists) {
                showError(registerError, 'Le nom d\'utilisateur du parrain n\'existe pas!');
                return;
            }
        }
        
        try {
            // Afficher l'état de chargement
            const originalText = submitRegister.innerHTML;
            submitRegister.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + translations[currentLanguage].createAccountText + '...';
            submitRegister.disabled = true;
            
            const userCredential = await firebaseFunctions.createUserWithEmailAndPassword(auth, email, password);
            // Créer le profil utilisateur dans Firestore
            await createUserProfile(userCredential.user, email, username, sponsor || null);
            closeAuthModal();
            showModalAlert(translations[currentLanguage].registerSuccess, 'success');
        } catch (error) {
            showError(registerError, getAuthErrorMessage(error.code));
            
            // Restaurer le bouton
            submitRegister.innerHTML = '<i class="fas fa-user-plus"></i> ' + translations[currentLanguage].createAccountText;
            submitRegister.disabled = false;
        }
    }
    
    async function createUserProfile(user, email, username, sponsorUsername = null) {
        // Donner 1 € de bonus si un parrain est spécifié
        const initialTokens = sponsorUsername ? 1 : 0;
        
        const userData = {
            email: email,
            username: username,
            tokens: initialTokens,
            tokensRecovered: 0,
            bestScore: 0,
            gamesPlayed: 0,
            maxLevel: 1,
            sponsor: sponsorUsername,
            sponsoredUsers: [],
            referralEarnings: 0,
            createdAt: new Date().toISOString(),
            lastLogin: new Date().toISOString()
        };
        
        // Utiliser une transaction pour garantir l'atomicité
        const batch = firebaseFunctions.writeBatch(db);
        
        // Créer le document utilisateur
        batch.set(firebaseFunctions.doc(db, "users", user.uid), userData);
        
        // Réserver le nom d'utilisateur
        batch.set(firebaseFunctions.doc(db, "usernames", username), {
            userId: user.uid,
            reservedAt: new Date().toISOString()
        });
        
        // Si un parrain est spécifié, ajouter l'utilisateur à la liste des filleuls
        if (sponsorUsername) {
            const sponsorQuery = firebaseFunctions.query(
                firebaseFunctions.collection(db, "users"),
                firebaseFunctions.where("username", "==", sponsorUsername)
            );
            
            const querySnapshot = await firebaseFunctions.getDocs(sponsorQuery);
            if (!querySnapshot.empty) {
                const sponsorDoc = querySnapshot.docs[0];
                const sponsorData = sponsorDoc.data();
                const updatedSponsoredUsers = [...(sponsorData.sponsoredUsers || []), username];
                
                batch.update(firebaseFunctions.doc(db, "users", sponsorDoc.id), {
                    sponsoredUsers: updatedSponsoredUsers
                });
            }
        }
        
        await batch.commit();
    }
    
    async function logoutUser() {
        try {
            await firebaseFunctions.signOut(auth);
            showModalAlert(translations[currentLanguage].logoutSuccess, 'info');
        } catch (error) {
            console.error('Erreur de déconnexion:', error);
        }
    }
    
    async function loadUserData() {
        if (!currentUser) return;
        
        try {
            const userDoc = await firebaseFunctions.getDoc(firebaseFunctions.doc(db, "users", currentUser.uid));
            if (userDoc.exists()) {
                currentUserData = userDoc.data();
                tokens = currentUserData.tokens || 0;
                tokensRecovered = currentUserData.tokensRecovered || 0;
                bestScore = currentUserData.bestScore || 0;
                gamesPlayed = currentUserData.gamesPlayed || 0;
                maxLevel = currentUserData.maxLevel || 1;
                
                updateTokenDisplay();
                bestScoreElement.textContent = bestScore;
                gamesPlayedElement.textContent = gamesPlayed;
                tokensRecoveredElement.textContent = tokensRecovered.toFixed(2);
                maxLevelElement.textContent = maxLevel;
                
                // Afficher les informations du parrain
                if (currentUserData.sponsor) {
                    sponsorName.textContent = currentUserData.sponsor;
                    sponsorInfo.style.display = 'block';
                } else {
                    sponsorInfo.style.display = 'none';
                }
                
                // Afficher la section de parrainage avec le code de l'utilisateur
                if (currentUserData.username) {
                    referralCode.textContent = currentUserData.username;
                    referralCount.textContent = currentUserData.sponsoredUsers ? currentUserData.sponsoredUsers.length : 0;
                    referralEarnings.textContent = (currentUserData.referralEarnings || 0).toFixed(2);
                    referralSection.style.display = 'block';
                }
                
                // Désactiver le bouton de démarrage si l'utilisateur a de l'argent non récupéré
                startBtn.disabled = tokens > 0;
                
                // Vérifier si l'utilisateur a de l'argent non récupéré au chargement
                if (tokens > 0) {
                    setTimeout(() => {
                        showModalAlert(translations[currentLanguage].mustRecoverAlert, 'warning');
                        scrollToRecoverButton();
                    }, 1000);
                }
            }
        } catch (error) {
            console.error('Erreur lors du chargement des données:', error);
        }
    }
    
    async function saveUserData() {
        if (!currentUser) return;
        
        try {
            const userRef = firebaseFunctions.doc(db, "users", currentUser.uid);
            await firebaseFunctions.updateDoc(userRef, {
                tokens: tokens,
                tokensRecovered: tokensRecovered,
                bestScore: bestScore,
                gamesPlayed: gamesPlayed,
                maxLevel: maxLevel,
                lastLogin: new Date().toISOString()
            });
        } catch (error) {
            console.error('Erreur lors de la sauvegarde:', error);
        }
    }
    
    async function loadLeaderboard() {
        if (!currentUser) return;
        
        leaderboardLoading.style.display = 'block';
        leaderboardList.innerHTML = '';
        
        try {
            // TRIER PAR ARGENT GAGNÉ (tokensRecovered)
            const usersQuery = firebaseFunctions.query(
                firebaseFunctions.collection(db, "users"),
                firebaseFunctions.orderBy("tokensRecovered", "desc")
            );
            
            const querySnapshot = await firebaseFunctions.getDocs(usersQuery);
            let rank = 1;
            
            querySnapshot.forEach((doc) => {
                if (rank > 10) return; // Limiter à 10 premiers
                
                const userData = doc.data();
                const leaderboardItem = document.createElement('div');
                leaderboardItem.className = 'leaderboard-item';
                if (rank === 1) leaderboardItem.style.background = 'rgba(255, 215, 0, 0.3)';
                
                leaderboardItem.innerHTML = `
                    <div><span class="leaderboard-rank">${rank}.</span> ${userData.username || userData.email}</div>
                    <div>${(userData.tokensRecovered || 0).toFixed(2)} €</div>
                `;
                
                leaderboardList.appendChild(leaderboardItem);
                rank++;
            });
            
            if (querySnapshot.empty) {
                leaderboardList.innerHTML = '<div class="leaderboard-item">Aucun joueur encore</div>';
            }
        } catch (error) {
            console.error('Erreur lors du chargement du classement:', error);
            leaderboardList.innerHTML = '<div class="leaderboard-item">Erreur de chargement</div>';
        } finally {
            leaderboardLoading.style.display = 'none';
        }
    }
    
    async function checkUsernameUnique(username) {
        try {
            const usernameDoc = await firebaseFunctions.getDoc(
                firebaseFunctions.doc(db, "usernames", username)
            );
            return !usernameDoc.exists();
        } catch (error) {
            console.error("Erreur lors de la vérification du nom d'utilisateur:", error);
            return false;
        }
    }
    
    async function checkSponsorExists(sponsorUsername) {
        try {
            const sponsorQuery = firebaseFunctions.query(
                firebaseFunctions.collection(db, "users"),
                firebaseFunctions.where("username", "==", sponsorUsername)
            );
            
            const querySnapshot = await firebaseFunctions.getDocs(sponsorQuery);
            return !querySnapshot.empty;
        } catch (error) {
            console.error("Erreur lors de la vérification du parrain:", error);
            return false;
        }
    }
    
    async function checkUsernameAvailability() {
        const username = registerUsername.value.trim();
        
        if (username.length < 3) {
            usernameFeedback.textContent = 'Minimum 3 caractères';
            usernameFeedback.className = 'username-feedback';
            return;
        }
        
        if (username.length > 20) {
            usernameFeedback.textContent = 'Maximum 20 caractères';
            usernameFeedback.className = 'username-feedback username-taken';
            return;
        }
        
        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
            usernameFeedback.textContent = 'Lettres, chiffres et underscores seulement';
            usernameFeedback.className = 'username-feedback username-taken';
            return;
        }
        
        const isAvailable = await checkUsernameUnique(username);
        
        if (isAvailable) {
            usernameFeedback.textContent = '✓ Nom disponible';
            usernameFeedback.className = 'username-feedback username-available';
        } else {
            usernameFeedback.textContent = '✗ Nom déjà pris';
            usernameFeedback.className = 'username-feedback username-taken';
        }
    }
    
    async function checkSponsorExistence() {
        const sponsor = sponsorUsername.value.trim();
        
        if (sponsor.length === 0) {
            sponsorFeedback.textContent = '';
            return;
        }
        
        const exists = await checkSponsorExists(sponsor);
        
        if (exists) {
            sponsorFeedback.textContent = '✓ Parrain trouvé';
            sponsorFeedback.className = 'username-feedback username-available';
        } else {
            sponsorFeedback.textContent = '✗ Parrain non trouvé';
            sponsorFeedback.className = 'username-feedback username-taken';
        }
    }
    
    async function handleSponsorRewards(sponsoredUserUsername, tokensEarned) {
        try {
            // Trouver le parrain par nom d'utilisateur
            const sponsorQuery = firebaseFunctions.query(
                firebaseFunctions.collection(db, "users"),
                firebaseFunctions.where("username", "==", sponsoredUserUsername)
            );
            
            const querySnapshot = await firebaseFunctions.getDocs(sponsorQuery);
            
            if (!querySnapshot.empty) {
                const sponsorDoc = querySnapshot.docs[0];
                const sponsorData = sponsorDoc.data();
                const sponsorReward = 1 + (tokensEarned * 0.05); // 1 € + 5% des gains
                
                // Mettre à jour l'argent du parrain
                await firebaseFunctions.updateDoc(firebaseFunctions.doc(db, "users", sponsorDoc.id), {
                    tokens: (sponsorData.tokens || 0) + sponsorReward,
                    referralEarnings: (sponsorData.referralEarnings || 0) + sponsorReward,
                    lastSponsorReward: {
                        from: currentUserData.username,
                        amount: sponsorReward,
                        date: new Date().toISOString()
                    }
                });
                
                console.log(`Parrain ${sponsoredUserUsername} a gagné ${sponsorReward.toFixed(2)} €`);
            }
        } catch (error) {
            console.error("Erreur lors du traitement des récompenses du parrain:", error);
        }
    }
    
    function updateUI() {
        if (userLoggedIn && currentUser) {
            authButtons.style.display = 'none';
            userPanel.style.display = 'flex';
            userNameElement.textContent = currentUserData ? currentUserData.username : currentUser.email.split('@')[0];
            updateTokenDisplay();
        } else {
            authButtons.style.display = 'flex';
            userPanel.style.display = 'none';
            resetGame();
        }
    }
    
    function showError(element, message) {
        element.textContent = message;
        element.style.display = 'block';
    }
    
    function getAuthErrorMessage(errorCode) {
        const errorMessages = {
            'auth/invalid-email': 'Adresse email invalide',
            'auth/user-disabled': 'Ce compte a été désactivé',
            'auth/user-not-found': 'Aucun compte trouvé avec cet email',
            'auth/wrong-password': 'Mot de passe incorrect',
            'auth/email-already-in-use': 'Un compte existe déjà avec cet email',
            'auth/weak-password': 'Le mot de passe est trop faible',
            'auth/network-request-failed': 'Erreur de réseau. Vérifiez votre connexion'
        };
        
        return errorMessages[errorCode] || 'Une erreur est survenue. Veuillez réessayer.';
    }
    
    
</script>
</body>
</html>
