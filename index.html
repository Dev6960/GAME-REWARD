<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GAME REWARD - Jeu de Casse-Briques</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, orderBy, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD7ePIu7x4KbojvUD47DWSKbuqH5nzE5uc",
            authDomain: "laafi-bf.firebaseapp.com",
            projectId: "laafi-bf",
            storageBucket: "laafi-bf.firebasestorage.app",
            messagingSenderId: "837012050847",
            appId: "1:837012050847:web:f7eae39f1a985b3596e3aa",
            measurementId: "G-W6HHK2WTVF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseFunctions = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            doc,
            setDoc,
            getDoc,
            updateDoc,
            collection,
            getDocs,
            orderBy,
            query,
            where,
            writeBatch
        };
        
        console.log("Firebase initialisé avec succès!");
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
            color: #FFD700;
        }
        
        .logo h1 {
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .user-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #FFD700;
            color: #333;
        }
        
        .btn-primary:hover {
            background: #FFC400;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .game-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #FFD700;
        }
        
        .info-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        #gameCanvas {
            background: #0a0e2a;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 800px;
        }
        
        .game-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-btn {
            padding: 12px 25px;
            font-size: 1rem;
        }
        
        .touch-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 300px;
            margin-top: 20px;
            padding: 0 20px;
        }
        
        .control-arrow {
            width: 60px;
            height: 60px;
            font-size: 24px;
            background: rgba(255, 215, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .control-arrow:active {
            background: rgba(255, 215, 0, 1);
            transform: scale(0.95);
        }
        
        .stats-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .token-display {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .token-count {
            font-size: 3rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            margin: 10px 0;
        }
        
        .token-label {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .recover-section {
            text-align: center;
            margin: 30px 0;
            position: sticky;
            bottom: 20px;
            z-index: 100;
            background: rgba(26, 42, 108, 0.9);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .recover-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .recover-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.6);
        }
        
        .recover-btn:disabled {
            background: #9E9E9E;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .recover-message {
            margin-top: 15px;
            padding: 10px;
            background: rgba(76, 175, 80, 0.2);
            border-radius: 5px;
            display: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #FFD700;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .leaderboard {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-top: 30px;
        }
        
        .leaderboard h2 {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .leaderboard-item:first-child {
            background: rgba(255, 215, 0, 0.3);
        }
        
        .leaderboard-rank {
            font-weight: bold;
            margin-right: 10px;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        
        .tab.active {
            opacity: 1;
            border-bottom: 2px solid #FFD700;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }
        
        .username-feedback {
            font-size: 0.8rem;
            margin-top: 5px;
            height: 20px;
        }
        
        .username-available {
            color: #4CAF50;
        }
        
        .username-taken {
            color: #f44336;
        }
        
        .modal-btn {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: #FFD700;
            color: #333;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }
        
        .modal-btn:hover {
            background: #FFC400;
        }
        
        .user-panel {
            display: none;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-name {
            font-weight: bold;
        }
        
        .user-level {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        /* Game Over Screen */
        .game-over {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            padding: 20px;
        }
        
        .game-over-content {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        }
        
        .game-over h2 {
            font-size: 3rem;
            color: #FFD700;
            margin-bottom: 20px;
        }
        
        .game-over p {
            font-size: 1.5rem;
            margin-bottom: 30px;
        }
        
        .game-over-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .game-over-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .restart-btn {
            background: #FFD700;
            color: #333;
        }
        
        .restart-btn:hover {
            background: #FFC400;
            transform: translateY(-3px);
        }
        
        .recover-game-over-btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .recover-game-over-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .recover-game-over-btn:disabled {
            background: #9E9E9E;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Instructions */
        .instructions {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #FFD700;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 10px;
        }

        .error-message {
            color: #ff6b6b;
            text-align: center;
            margin-top: 10px;
            display: none;
        }
        
        .sponsor-info {
            background: rgba(255, 215, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }
        
        .sponsor-bonus {
            color: #4CAF50;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        /* Alert Modal Styles */
        .alert-body {
            text-align: center;
            padding: 20px;
        }

        .alert-body p {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        .success-alert {
            color: #4CAF50;
        }
        
        .warning-alert {
            color: #FF9800;
        }
        
        .error-alert {
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-gamepad"></i>
                <h1>GAME REWARD</h1>
            </div>
            <div class="user-actions">
                <div id="authButtons">
                    <button class="btn btn-primary" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i> Connexion
                    </button>
                    <button class="btn btn-secondary" id="registerBtn">
                        <i class="fas fa-user-plus"></i> Inscription
                    </button>
                </div>
                <div class="user-panel" id="userPanel">
                    <div class="user-info">
                        <div class="user-name" id="userName">Joueur</div>
                        <div class="user-level">Jetons: <span id="userTokens">0</span></div>
                    </div>
                    <div class="avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <button class="btn btn-secondary" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <section class="game-container">
                <div class="game-info">
                    <div class="info-item">
                        <div class="info-value" id="score">0</div>
                        <div class="info-label">Score</div>
                    </div>
                    <div class="info-item">
                        <div class="info-value" id="level">1</div>
                        <div class="info-label">Niveau</div>
                    </div>
                    <div class="info-item">
                        <div class="info-value" id="lives">3</div>
                        <div class="info-label">Vies</div>
                    </div>
                </div>
                
                <canvas id="gameCanvas" width="800" height="500"></canvas>
                
                <div class="touch-controls">
                    <button class="control-arrow left-arrow" id="leftArrow">←</button>
                    <button class="control-arrow right-arrow" id="rightArrow">→</button>
                </div>
                
                <div class="game-controls">
                    <button class="btn btn-primary control-btn" id="startBtn">
                        <i class="fas fa-play"></i> Commencer
                    </button>
                    <button class="btn btn-secondary control-btn" id="pauseBtn">
                        <i class="fas fa-pause"></i> Pause
                    </button>
                    <button class="btn btn-secondary control-btn" id="resetBtn">
                        <i class="fas fa-redo"></i> Recommencer
                    </button>
                </div>
                
                <div class="instructions">
                    <h3>Comment jouer:</h3>
                    <ul>
                        <li>Utilisez les touches ← et → ou les boutons pour déplacer la raquette</li>
                        <li>Cassez toutes les briques pour passer au niveau suivant</li>
                        <li>Chaque brique cassée = 1 point = 0.05 jetons</li>
                        <li>Récupérez vos jetons après avoir joué pour rejouer</li>
                    </ul>
                </div>
                
                <div class="game-over" id="gameOverScreen">
                    <div class="game-over-content">
                        <h2>Partie Terminée</h2>
                        <p>Score final: <span id="finalScore">0</span></p>
                        <p>Jetons gagnés: <span id="tokensEarned">0</span></p>
                        
                        <div class="game-over-buttons">
                            <button class="game-over-btn restart-btn" id="restartBtn">
                                <i class="fas fa-redo"></i> Rejouer
                            </button>
                            <button class="game-over-btn recover-game-over-btn" id="recoverGameOverBtn" disabled>
                                <i class="fas fa-gem"></i> Récupérer les Jetons
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="stats-area">
                <div class="token-display">
                    <div class="token-label">Vos Jetons</div>
                    <div class="token-count" id="tokenCount">0</div>
                    <div class="token-label">1 brique = 1 point = 0.05 jetons</div>
                </div>
                
                <div class="recover-section">
                    <button class="recover-btn" id="recoverBtn" disabled>
                        <i class="fas fa-gem"></i> Récupérer les Jetons
                    </button>
                    <div class="recover-message" id="recoverMessage">
                        <i class="fas fa-check-circle"></i> Jetons récupérés avec succès!
                    </div>
                </div>
                
                <h2>Statistiques de Jeu</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Meilleur Score</div>
                        <div class="stat-value" id="bestScore">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Parties Jouées</div>
                        <div class="stat-value" id="gamesPlayed">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Jetons Récupérés</div>
                        <div class="stat-value" id="tokensRecovered">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Niveau Max</div>
                        <div class="stat-value" id="maxLevel">1</div>
                    </div>
                </div>
                
                <div class="sponsor-info" id="sponsorInfo" style="display: none;">
                    <h3><i class="fas fa-user-friends"></i> Programme de Parrainage</h3>
                    <p>Parrain: <span id="sponsorName">-</span></p>
                    <p>Votre parrain gagne 1 jeton + 5% de vos gains!</p>
                </div>
            </section>
        </div>
        
        <section class="leaderboard">
            <h2>Classement des Joueurs</h2>
            <div class="loading" id="leaderboardLoading">
                <i class="fas fa-spinner fa-spin"></i> Chargement...
            </div>
            <div id="leaderboardList">
                <!-- Le classement sera chargé dynamiquement -->
            </div>
        </section>
        
        <footer>
            <p>GAME REWARD  &copy; 2025- 1 brique = 1 point = 0.05 jetons</p>
        </footer>
    </div>
    
    <!-- Modal de Connexion/Inscription -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <button class="close-modal" id="closeModal">&times;</button>
            <div class="modal-tabs">
                <div class="tab active" data-tab="login">Connexion</div>
                <div class="tab" data-tab="register">Inscription</div>
            </div>
            
            <div class="tab-content active" id="loginTab">
                <h2>Connexion</h2>
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="Votre adresse email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Mot de passe:</label>
                    <input type="password" id="loginPassword" placeholder="Votre mot de passe">
                </div>
                <div class="error-message" id="loginError"></div>
                <button class="modal-btn" id="submitLogin">
                    <i class="fas fa-sign-in-alt"></i> Se connecter
                </button>
            </div>
            
            <div class="tab-content" id="registerTab">
                <h2>Inscription</h2>
                <div class="form-group">
                    <label for="registerUsername">Nom d'utilisateur:</label>
                    <input type="text" id="registerUsername" placeholder="Choisissez un nom unique">
                    <div class="username-feedback" id="usernameFeedback"></div>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email:</label>
                    <input type="email" id="registerEmail" placeholder="Votre adresse email">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Mot de passe:</label>
                    <input type="password" id="registerPassword" placeholder="Créez un mot de passe (min. 6 caractères)">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirmer le mot de passe:</label>
                    <input type="password" id="confirmPassword" placeholder="Confirmez votre mot de passe">
                </div>
                <div class="form-group">
                    <label for="sponsorUsername">Nom du parrain (optionnel):</label>
                    <input type="text" id="sponsorUsername" placeholder="Username de votre parrain">
                    <div class="username-feedback" id="sponsorFeedback"></div>
                    <div class="sponsor-bonus">
                        <i class="fas fa-gift"></i> Bonus: 1 jeton offert avec un code parrain!
                    </div>
                </div>
                <div class="error-message" id="registerError"></div>
                <button class="modal-btn" id="submitRegister">
                    <i class="fas fa-user-plus"></i> Créer un compte
                </button>
            </div>
        </div>
    </div>

    <!-- Modal d'alerte -->
    <div class="modal" id="alertModal">
        <div class="modal-content">
            <div class="alert-body">
                <p id="alertMessage"></p>
                <button class="modal-btn" id="closeAlert">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let tokens = 0;
        let tokensEarned = 0;
        let tokensRecovered = 0;
        let bestScore = 0;
        let gamesPlayed = 0;
        let maxLevel = 1;
        let userLoggedIn = false;
        let currentUser = null;
        let currentUserData = null;
        
        // Variables du jeu
        let canvas, ctx;
        let gameRunning = false;
        let gamePaused = false;
        let score = 0;
        let level = 1;
        let lives = 3;
        
        // Éléments du jeu
        let paddle, ball, bricks = [];
        
        // Éléments DOM
        const tokenCountElement = document.getElementById('tokenCount');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const livesElement = document.getElementById('lives');
        const recoverBtn = document.getElementById('recoverBtn');
        const recoverMessage = document.getElementById('recoverMessage');
        const bestScoreElement = document.getElementById('bestScore');
        const gamesPlayedElement = document.getElementById('gamesPlayed');
        const tokensRecoveredElement = document.getElementById('tokensRecovered');
        const maxLevelElement = document.getElementById('maxLevel');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreElement = document.getElementById('finalScore');
        const tokensEarnedElement = document.getElementById('tokensEarned');
        const restartBtn = document.getElementById('restartBtn');
        const recoverGameOverBtn = document.getElementById('recoverGameOverBtn');
        const authModal = document.getElementById('authModal');
        const closeModal = document.getElementById('closeModal');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const submitLogin = document.getElementById('submitLogin');
        const submitRegister = document.getElementById('submitRegister');
        const authButtons = document.getElementById('authButtons');
        const userPanel = document.getElementById('userPanel');
        const userNameElement = document.getElementById('userName');
        const userTokensElement = document.getElementById('userTokens');
        const logoutBtn = document.getElementById('logoutBtn');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const loginError = document.getElementById('loginError');
        const registerError = document.getElementById('registerError');
        const leaderboardList = document.getElementById('leaderboardList');
        const leaderboardLoading = document.getElementById('leaderboardLoading');
        const leftArrow = document.getElementById('leftArrow');
        const rightArrow = document.getElementById('rightArrow');
        const registerUsername = document.getElementById('registerUsername');
        const usernameFeedback = document.getElementById('usernameFeedback');
        const sponsorUsername = document.getElementById('sponsorUsername');
        const sponsorFeedback = document.getElementById('sponsorFeedback');
        const sponsorInfo = document.getElementById('sponsorInfo');
        const sponsorName = document.getElementById('sponsorName');
        const alertModal = document.getElementById('alertModal');
        const alertMessage = document.getElementById('alertMessage');
        const closeAlert = document.getElementById('closeAlert');

        // Initialisation Firebase
        let auth, db;
        let firebaseFunctions;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Attendre que Firebase soit chargé
            setTimeout(initializeApp, 100);
        });

        function initializeApp() {
            auth = window.firebaseAuth;
            db = window.firebaseDb;
            firebaseFunctions = window.firebaseFunctions;

            if (!auth || !db) {
                console.error("Firebase n'est pas initialisé correctement");
                return;
            }

            // Initialiser le canvas
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // Surveiller l'état d'authentification
            firebaseFunctions.onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    userLoggedIn = true;
                    loadUserData();
                    updateUI();
                    loadLeaderboard();
                } else {
                    currentUser = null;
                    userLoggedIn = false;
                    updateUI();
                }
            });
            
            // Initialiser le jeu
            initGame();
            
            // Événements de contrôle
            document.addEventListener('keydown', keyDownHandler);
            document.addEventListener('keyup', keyUpHandler);
            
            // Événements des boutons
            startBtn.addEventListener('click', startGame);
            pauseBtn.addEventListener('click', togglePause);
            resetBtn.addEventListener('click', resetGame);
            restartBtn.addEventListener('click', restartGame);
            recoverBtn.addEventListener('click', recoverTokens);
            recoverGameOverBtn.addEventListener('click', recoverTokensFromGameOver);
            
            // Événements des flèches tactiles
            leftArrow.addEventListener('mousedown', () => paddle.dx = -paddle.speed);
            leftArrow.addEventListener('mouseup', () => paddle.dx = 0);
            leftArrow.addEventListener('touchstart', () => paddle.dx = -paddle.speed);
            leftArrow.addEventListener('touchend', () => paddle.dx = 0);
            
            rightArrow.addEventListener('mousedown', () => paddle.dx = paddle.speed);
            rightArrow.addEventListener('mouseup', () => paddle.dx = 0);
            rightArrow.addEventListener('touchstart', () => paddle.dx = paddle.speed);
            rightArrow.addEventListener('touchend', () => paddle.dx = 0);
            
            // Événements d'authentification
            loginBtn.addEventListener('click', showAuthModal);
            registerBtn.addEventListener('click', showAuthModal);
            closeModal.addEventListener('click', closeAuthModal);
            submitLogin.addEventListener('click', submitLoginForm);
            submitRegister.addEventListener('click', submitRegisterForm);
            logoutBtn.addEventListener('click', logoutUser);
            
            // Vérification du nom d'utilisateur en temps réel
            registerUsername.addEventListener('input', checkUsernameAvailability);
            sponsorUsername.addEventListener('input', checkSponsorExistence);
            
            // Événement pour fermer l'alerte
            closeAlert.addEventListener('click', () => {
                alertModal.style.display = 'none';
            });
            
            // Changer d'onglet dans la modal
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Désactiver tous les onglets
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    // Activer l'onglet sélectionné
                    this.classList.add('active');
                    document.getElementById(tabId + 'Tab').classList.add('active');
                });
            });
            
            // Boucle de jeu
            requestAnimationFrame(gameLoop);
        }

        // Fonction pour déclencher l'URL de récupération
        function triggerTokenRecovery() {
            // Ouvrir l'URL dans un nouvel onglet
            window.open('https://absolvedowntowninteger.com/yxg22edmt5?key=ebf623286659a485611ac6e4071ab1c1', '_blank');
        }

        // Système d'alerte modal
        function showModalAlert(message, type = 'info') {
            alertMessage.textContent = message;
            
            // Appliquer une classe selon le type d'alerte
            alertMessage.className = '';
            if (type === 'success') {
                alertMessage.classList.add('success-alert');
            } else if (type === 'warning') {
                alertMessage.classList.add('warning-alert');
            } else if (type === 'error') {
                alertMessage.classList.add('error-alert');
            }
            
            alertModal.style.display = 'flex';
        }

        // Fonctions de défilement
        function scrollToRecoverButton() {
            const recoverSection = document.querySelector('.recover-section');
            recoverSection.scrollIntoView({ 
                behavior: 'smooth',
                block: 'center'
            });
        }

        function scrollToGame() {
            const gameContainer = document.querySelector('.game-container');
            gameContainer.scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Initialisation du jeu
        function initGame() {
            // Créer la raquette
            paddle = {
                x: canvas.width / 2 - 50,
                y: canvas.height - 20,
                width: 100,
                height: 10,
                speed: 8,
                dx: 0
            };
            
            // Créer la balle
            ball = {
                x: canvas.width / 2,
                y: canvas.height - 30,
                radius: 8,
                speed: 5,
                dx: 5,
                dy: -5
            };
            
            // Créer les briques
            createBricks();
        }
        
        // Créer les briques
        function createBricks() {
            bricks = [];
            const brickRows = 5;
            const brickCols = 10;
            const brickWidth = 70;
            const brickHeight = 20;
            const brickPadding = 5;
            const brickOffsetTop = 50;
            const brickOffsetLeft = 20;
            
            for (let r = 0; r < brickRows; r++) {
                for (let c = 0; c < brickCols; c++) {
                    const brickX = c * (brickWidth + brickPadding) + brickOffsetLeft;
                    const brickY = r * (brickHeight + brickPadding) + brickOffsetTop;
                    
                    // Couleur différente selon la ligne
                    let color;
                    if (r === 0) color = '#FF5252';
                    else if (r === 1) color = '#FF9800';
                    else if (r === 2) color = '#FFEB3B';
                    else if (r === 3) color = '#4CAF50';
                    else color = '#2196F3';
                    
                    bricks.push({
                        x: brickX,
                        y: brickY,
                        width: brickWidth,
                        height: brickHeight,
                        color: color,
                        visible: true
                    });
                }
            }
        }
        
        // Dessiner la raquette
        function drawPaddle() {
            ctx.beginPath();
            ctx.rect(paddle.x, paddle.y, paddle.width, paddle.height);
            ctx.fillStyle = '#FFD700';
            ctx.fill();
            ctx.closePath();
        }
        
        // Dessiner la balle
        function drawBall() {
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = '#FFFFFF';
            ctx.fill();
            ctx.closePath();
        }
        
        // Dessiner les briques
        function drawBricks() {
            bricks.forEach(brick => {
                if (brick.visible) {
                    ctx.beginPath();
                    ctx.rect(brick.x, brick.y, brick.width, brick.height);
                    ctx.fillStyle = brick.color;
                    ctx.fill();
                    ctx.closePath();
                }
            });
        }
        
        // Dessiner le jeu
        function draw() {
            // Effacer le canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dessiner les éléments
            drawBricks();
            drawPaddle();
            drawBall();
            
            // Dessiner les informations de jeu si en pause
            if (gamePaused) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.font = '40px Arial';
                ctx.fillStyle = '#FFD700';
                ctx.textAlign = 'center';
                ctx.fillText('PAUSE', canvas.width / 2, canvas.height / 2);
            }
        }
        
        // Mettre à jour le jeu
        function update() {
            if (gamePaused || !gameRunning) return;
            
            // Déplacer la raquette
            paddle.x += paddle.dx;
            
            // Empêcher la raquette de sortir de l'écran
            if (paddle.x < 0) {
                paddle.x = 0;
            } else if (paddle.x + paddle.width > canvas.width) {
                paddle.x = canvas.width - paddle.width;
            }
            
            // Déplacer la balle
            ball.x += ball.dx;
            ball.y += ball.dy;
            
            // Collision avec les murs
            if (ball.x + ball.radius > canvas.width || ball.x - ball.radius < 0) {
                ball.dx = -ball.dx;
            }
            
            // Collision avec le plafond
            if (ball.y - ball.radius < 0) {
                ball.dy = -ball.dy;
            }
            
            // Collision avec la raquette
            if (
                ball.y + ball.radius > paddle.y &&
                ball.x > paddle.x &&
                ball.x < paddle.x + paddle.width
            ) {
                ball.dy = -ball.dy;
                
                // Ajuster la direction en fonction de l'endroit où la balle touche la raquette
                const hitPoint = (ball.x - (paddle.x + paddle.width / 2)) / (paddle.width / 2);
                ball.dx = hitPoint * 7;
            }
            
            // Collision avec le sol (perdre une vie)
            if (ball.y + ball.radius > canvas.height) {
                lives--;
                livesElement.textContent = lives;
                
                if (lives <= 0) {
                    gameOver();
                } else {
                    resetBall();
                }
            }
            
            // Collision avec les briques
            bricks.forEach(brick => {
                if (brick.visible) {
                    if (
                        ball.x + ball.radius > brick.x &&
                        ball.x - ball.radius < brick.x + brick.width &&
                        ball.y + ball.radius > brick.y &&
                        ball.y - ball.radius < brick.y + brick.height
                    ) {
                        ball.dy = -ball.dy;
                        brick.visible = false;
                        
                        // Augmenter le score (1 point par brique)
                        score += 1;
                        scoreElement.textContent = score;
                        
                        // Vérifier si toutes les briques sont cassées
                        if (bricks.every(b => !b.visible)) {
                            levelUp();
                        }
                    }
                }
            });
        }
        
        // Réinitialiser la balle
        function resetBall() {
            ball.x = canvas.width / 2;
            ball.y = canvas.height - 30;
            ball.dx = 5 * (Math.random() > 0.5 ? 1 : -1);
            ball.dy = -5;
        }
        
        // Passer au niveau suivant
        function levelUp() {
            level++;
            levelElement.textContent = level;
            
            if (level > maxLevel) {
                maxLevel = level;
                maxLevelElement.textContent = maxLevel;
            }
            
            // Réinitialiser la balle et les briques
            resetBall();
            createBricks();
            
            // Augmenter la vitesse de la balle
            ball.speed += 0.5;
            ball.dx = ball.dx > 0 ? ball.speed : -ball.speed;
            ball.dy = ball.dy > 0 ? ball.speed : -ball.speed;
        }
        
        // Game Over
        function gameOver() {
            gameRunning = false;
            gamesPlayed++;
            gamesPlayedElement.textContent = gamesPlayed;
            
            // Calculer les jetons gagnés (1 point = 0.05 jetons)
            tokensEarned = score * 0.05;
            tokens += tokensEarned;
            
            // Mettre à jour le meilleur score
            if (score > bestScore) {
                bestScore = score;
                bestScoreElement.textContent = bestScore;
            }
            
            // Traiter les récompenses du parrain
            if (currentUser && currentUserData && currentUserData.sponsor) {
                handleSponsorRewards(currentUserData.sponsor, tokensEarned);
            }
            
            // Afficher l'écran de fin de jeu
            finalScoreElement.textContent = score;
            tokensEarnedElement.textContent = tokensEarned.toFixed(2);
            gameOverScreen.style.display = 'flex';
            
            // Activer les boutons de récupération
            recoverBtn.disabled = false;
            recoverGameOverBtn.disabled = false;
            
            // Désactiver le bouton de démarrage si l'utilisateur a des jetons non récupérés
            startBtn.disabled = tokens > 0;
            
            // Sauvegarder les données utilisateur
            saveUserData();
            
            updateTokenDisplay();
        }
        
        // Boucle de jeu
        function gameLoop() {
            draw();
            update();
            requestAnimationFrame(gameLoop);
        }
        
        // Gestionnaires d'événements clavier
        function keyDownHandler(e) {
            if (e.key === 'Right' || e.key === 'ArrowRight') {
                paddle.dx = paddle.speed;
            } else if (e.key === 'Left' || e.key === 'ArrowLeft') {
                paddle.dx = -paddle.speed;
            }
        }
        
        function keyUpHandler(e) {
            if (e.key === 'Right' || e.key === 'ArrowRight' || e.key === 'Left' || e.key === 'ArrowLeft') {
                paddle.dx = 0;
            }
        }
        
        // Contrôles du jeu
        function startGame() {
            if (!userLoggedIn) {
                showAuthModal();
                return;
            }
            
            // Vérifier si l'utilisateur a des jetons non récupérés
            if (tokens > 0) {
                showModalAlert("Vous devez récupérer vos jetons avant de rejouer!", 'warning');
                scrollToRecoverButton();
                return;
            }
            
            gameRunning = true;
            gamePaused = false;
            startBtn.disabled = true;
        }
        
        function togglePause() {
            if (!gameRunning) return;
            gamePaused = !gamePaused;
        }
        
        function resetGame() {
            score = 0;
            level = 1;
            lives = 3;
            
            scoreElement.textContent = score;
            levelElement.textContent = level;
            livesElement.textContent = lives;
            
            gameRunning = false;
            gamePaused = false;
            startBtn.disabled = false;
            gameOverScreen.style.display = 'none';
            
            initGame();
        }
        
        function restartGame() {
            resetGame();
            startGame();
        }
        
        // Récupérer les jetons
        function recoverTokens() {
            if (tokens > 0) {
                // Déclencher l'URL automatiquement
                triggerTokenRecovery();
                
                tokensRecovered += tokens;
                
                // Réinitialiser les jetons pour permettre de rejouer
                tokens = 0;
                tokensEarned = 0;
                
                updateTokenDisplay();
                tokensRecoveredElement.textContent = tokensRecovered.toFixed(2);
                recoverBtn.disabled = true;
                
                // Réactiver le bouton de démarrage
                startBtn.disabled = false;
                
                // Afficher le message de confirmation dans une modal
                showModalAlert('Jetons récupérés avec succès!', 'success');
                
                saveUserData();
                
                // Faire défiler vers le jeu
                setTimeout(scrollToGame, 1000);
            }
        }
        
        // Récupérer les jetons depuis l'écran de fin de partie
        function recoverTokensFromGameOver() {
            recoverTokens();
            // Masquer l'écran de fin de partie après récupération
            gameOverScreen.style.display = 'none';
            recoverGameOverBtn.disabled = true;
        }
        
        // Mettre à jour l'affichage des jetons
        function updateTokenDisplay() {
            tokenCountElement.textContent = tokens.toFixed(2);
            userTokensElement.textContent = tokens.toFixed(2);
        }
        
        // Système d'authentification Firebase
        function showAuthModal() {
            authModal.style.display = 'flex';
            loginError.style.display = 'none';
            registerError.style.display = 'none';
        }
        
        function closeAuthModal() {
            authModal.style.display = 'none';
            // Réinitialiser les formulaires
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('registerUsername').value = '';
            document.getElementById('sponsorUsername').value = '';
            usernameFeedback.textContent = '';
            sponsorFeedback.textContent = '';
        }
        
        async function submitLoginForm() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError(loginError, 'Veuillez remplir tous les champs!');
                return;
            }
            
            try {
                const userCredential = await firebaseFunctions.signInWithEmailAndPassword(auth, email, password);
                closeAuthModal();
                showModalAlert('Connexion réussie! Bienvenue ' + email + '!', 'success');
            } catch (error) {
                showError(loginError, getAuthErrorMessage(error.code));
            }
        }
        
        async function submitRegisterForm() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const username = document.getElementById('registerUsername').value;
            const sponsor = document.getElementById('sponsorUsername').value;
            
            if (!email || !password || !confirmPassword || !username) {
                showError(registerError, 'Veuillez remplir tous les champs obligatoires!');
                return;
            }
            
            if (password !== confirmPassword) {
                showError(registerError, 'Les mots de passe ne correspondent pas!');
                return;
            }
            
            if (password.length < 6) {
                showError(registerError, 'Le mot de passe doit contenir au moins 6 caractères');
                return;
            }
            
            if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
                showError(registerError, 'Le nom d\'utilisateur doit contenir entre 3 et 20 caractères (lettres, chiffres et underscores)');
                return;
            }
            
            // Vérifier si le nom d'utilisateur est disponible
            const isUsernameAvailable = await checkUsernameUnique(username);
            if (!isUsernameAvailable) {
                showError(registerError, 'Ce nom d\'utilisateur est déjà pris!');
                return;
            }
            
            // Vérifier si le parrain existe (seulement si un parrain est spécifié)
            if (sponsor && sponsor.trim() !== '') {
                const sponsorExists = await checkSponsorExists(sponsor);
                if (!sponsorExists) {
                    showError(registerError, 'Le nom d\'utilisateur du parrain n\'existe pas!');
                    return;
                }
            }
            
            try {
                // Afficher l'état de chargement
                const originalText = submitRegister.innerHTML;
                submitRegister.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Création en cours...';
                submitRegister.disabled = true;
                
                const userCredential = await firebaseFunctions.createUserWithEmailAndPassword(auth, email, password);
                // Créer le profil utilisateur dans Firestore
                await createUserProfile(userCredential.user, email, username, sponsor || null);
                closeAuthModal();
                showModalAlert('Compte créé avec succès! Bienvenue sur GAME REWARD !', 'success');
            } catch (error) {
                showError(registerError, getAuthErrorMessage(error.code));
                
                // Restaurer le bouton
                submitRegister.innerHTML = '<i class="fas fa-user-plus"></i> Créer un compte';
                submitRegister.disabled = false;
            }
        }
        
        async function createUserProfile(user, email, username, sponsorUsername = null) {
            // Donner 1 jeton de bonus si un parrain est spécifié
            const initialTokens = sponsorUsername ? 1 : 0;
            
            const userData = {
                email: email,
                username: username,
                tokens: initialTokens,
                tokensRecovered: 0,
                bestScore: 0,
                gamesPlayed: 0,
                maxLevel: 1,
                sponsor: sponsorUsername,
                sponsoredUsers: [],
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString()
            };
            
            // Utiliser une transaction pour garantir l'atomicité
            const batch = firebaseFunctions.writeBatch(db);
            
            // Créer le document utilisateur
            batch.set(firebaseFunctions.doc(db, "users", user.uid), userData);
            
            // Réserver le nom d'utilisateur
            batch.set(firebaseFunctions.doc(db, "usernames", username), {
                userId: user.uid,
                reservedAt: new Date().toISOString()
            });
            
            // Si un parrain est spécifié, ajouter l'utilisateur à la liste des filleuls
            if (sponsorUsername) {
                const sponsorQuery = firebaseFunctions.query(
                    firebaseFunctions.collection(db, "users"),
                    firebaseFunctions.where("username", "==", sponsorUsername)
                );
                
                const querySnapshot = await firebaseFunctions.getDocs(sponsorQuery);
                if (!querySnapshot.empty) {
                    const sponsorDoc = querySnapshot.docs[0];
                    const sponsorData = sponsorDoc.data();
                    const updatedSponsoredUsers = [...(sponsorData.sponsoredUsers || []), username];
                    
                    batch.update(firebaseFunctions.doc(db, "users", sponsorDoc.id), {
                        sponsoredUsers: updatedSponsoredUsers
                    });
                }
            }
            
            await batch.commit();
        }
        
        async function logoutUser() {
            try {
                await firebaseFunctions.signOut(auth);
                showModalAlert('Vous avez été déconnecté!', 'info');
            } catch (error) {
                console.error('Erreur de déconnexion:', error);
            }
        }
        
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await firebaseFunctions.getDoc(firebaseFunctions.doc(db, "users", currentUser.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    tokens = currentUserData.tokens || 0;
                    tokensRecovered = currentUserData.tokensRecovered || 0;
                    bestScore = currentUserData.bestScore || 0;
                    gamesPlayed = currentUserData.gamesPlayed || 0;
                    maxLevel = currentUserData.maxLevel || 1;
                    
                    updateTokenDisplay();
                    bestScoreElement.textContent = bestScore;
                    gamesPlayedElement.textContent = gamesPlayed;
                    tokensRecoveredElement.textContent = tokensRecovered.toFixed(2);
                    maxLevelElement.textContent = maxLevel;
                    
                    // Afficher les informations du parrain
                    if (currentUserData.sponsor) {
                        sponsorName.textContent = currentUserData.sponsor;
                        sponsorInfo.style.display = 'block';
                    } else {
                        sponsorInfo.style.display = 'none';
                    }
                    
                    // Désactiver le bouton de démarrage si l'utilisateur a des jetons non récupérés
                    startBtn.disabled = tokens > 0;
                    
                    // Vérifier si l'utilisateur a des jetons non récupérés au chargement
                    if (tokens > 0) {
                        setTimeout(() => {
                            showModalAlert('Vous avez des jetons à récupérer!', 'warning');
                            scrollToRecoverButton();
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
            }
        }
        
        async function saveUserData() {
            if (!currentUser) return;
            
            try {
                const userRef = firebaseFunctions.doc(db, "users", currentUser.uid);
                await firebaseFunctions.updateDoc(userRef, {
                    tokens: tokens,
                    tokensRecovered: tokensRecovered,
                    bestScore: bestScore,
                    gamesPlayed: gamesPlayed,
                    maxLevel: maxLevel,
                    lastLogin: new Date().toISOString()
                });
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
            }
        }
        
        async function loadLeaderboard() {
            if (!currentUser) return;
            
            leaderboardLoading.style.display = 'block';
            leaderboardList.innerHTML = '';
            
            try {
                const usersQuery = firebaseFunctions.query(
                    firebaseFunctions.collection(db, "users"),
                    firebaseFunctions.orderBy("bestScore", "desc")
                );
                
                const querySnapshot = await firebaseFunctions.getDocs(usersQuery);
                let rank = 1;
                
                querySnapshot.forEach((doc) => {
                    if (rank > 10) return; // Limiter à 10 premiers
                    
                    const userData = doc.data();
                    const leaderboardItem = document.createElement('div');
                    leaderboardItem.className = 'leaderboard-item';
                    if (rank === 1) leaderboardItem.style.background = 'rgba(255, 215, 0, 0.3)';
                    
                    leaderboardItem.innerHTML = `
                        <div><span class="leaderboard-rank">${rank}.</span> ${userData.username || userData.email}</div>
                        <div>${userData.bestScore || 0} points</div>
                    `;
                    
                    leaderboardList.appendChild(leaderboardItem);
                    rank++;
                });
                
                if (querySnapshot.empty) {
                    leaderboardList.innerHTML = '<div class="leaderboard-item">Aucun joueur encore</div>';
                }
            } catch (error) {
                console.error('Erreur lors du chargement du classement:', error);
                leaderboardList.innerHTML = '<div class="leaderboard-item">Erreur de chargement</div>';
            } finally {
                leaderboardLoading.style.display = 'none';
            }
        }
        
        async function checkUsernameUnique(username) {
            try {
                const usernameDoc = await firebaseFunctions.getDoc(
                    firebaseFunctions.doc(db, "usernames", username)
                );
                return !usernameDoc.exists();
            } catch (error) {
                console.error("Erreur lors de la vérification du nom d'utilisateur:", error);
                return false;
            }
        }
        
        async function checkSponsorExists(sponsorUsername) {
            try {
                const sponsorQuery = firebaseFunctions.query(
                    firebaseFunctions.collection(db, "users"),
                    firebaseFunctions.where("username", "==", sponsorUsername)
                );
                
                const querySnapshot = await firebaseFunctions.getDocs(sponsorQuery);
                return !querySnapshot.empty;
            } catch (error) {
                console.error("Erreur lors de la vérification du parrain:", error);
                return false;
            }
        }
        
        async function checkUsernameAvailability() {
            const username = registerUsername.value.trim();
            
            if (username.length < 3) {
                usernameFeedback.textContent = 'Minimum 3 caractères';
                usernameFeedback.className = 'username-feedback';
                return;
            }
            
            if (username.length > 20) {
                usernameFeedback.textContent = 'Maximum 20 caractères';
                usernameFeedback.className = 'username-feedback username-taken';
                return;
            }
            
            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                usernameFeedback.textContent = 'Lettres, chiffres et underscores seulement';
                usernameFeedback.className = 'username-feedback username-taken';
                return;
            }
            
            const isAvailable = await checkUsernameUnique(username);
            
            if (isAvailable) {
                usernameFeedback.textContent = '✓ Nom disponible';
                usernameFeedback.className = 'username-feedback username-available';
            } else {
                usernameFeedback.textContent = '✗ Nom déjà pris';
                usernameFeedback.className = 'username-feedback username-taken';
            }
        }
        
        async function checkSponsorExistence() {
            const sponsor = sponsorUsername.value.trim();
            
            if (sponsor.length === 0) {
                sponsorFeedback.textContent = '';
                return;
            }
            
            const exists = await checkSponsorExists(sponsor);
            
            if (exists) {
                sponsorFeedback.textContent = '✓ Parrain trouvé';
                sponsorFeedback.className = 'username-feedback username-available';
            } else {
                sponsorFeedback.textContent = '✗ Parrain non trouvé';
                sponsorFeedback.className = 'username-feedback username-taken';
            }
        }
        
        async function handleSponsorRewards(sponsoredUserUsername, tokensEarned) {
            try {
                // Trouver le parrain par nom d'utilisateur
                const sponsorsQuery = firebaseFunctions.query(
                    firebaseFunctions.collection(db, "users"),
                    firebaseFunctions.where("username", "==", sponsoredUserUsername)
                );
                
                const querySnapshot = await firebaseFunctions.getDocs(sponsorQuery);
                
                if (!querySnapshot.empty) {
                    const sponsorDoc = querySnapshot.docs[0];
                    const sponsorData = sponsorDoc.data();
                    const sponsorReward = 1 + (tokensEarned * 0.05); // 1 jeton + 5% des gains
                    
                    // Mettre à jour les jetons du parrain
                    await firebaseFunctions.updateDoc(firebaseFunctions.doc(db, "users", sponsorDoc.id), {
                        tokens: (sponsorData.tokens || 0) + sponsorReward,
                        lastSponsorReward: {
                            from: currentUserData.username,
                            amount: sponsorReward,
                            date: new Date().toISOString()
                        }
                    });
                    
                    console.log(`Parrain ${sponsoredUserUsername} a gagné ${sponsorReward.toFixed(2)} jetons`);
                }
            } catch (error) {
                console.error("Erreur lors du traitement des récompenses du parrain:", error);
            }
        }
        
        function updateUI() {
            if (userLoggedIn && currentUser) {
                authButtons.style.display = 'none';
                userPanel.style.display = 'flex';
                userNameElement.textContent = currentUserData ? currentUserData.username : currentUser.email.split('@')[0];
                updateTokenDisplay();
            } else {
                authButtons.style.display = 'flex';
                userPanel.style.display = 'none';
                resetGame();
            }
        }
        
        function showError(element, message) {
            element.textContent = message;
            element.style.display = 'block';
        }
        
        function getAuthErrorMessage(errorCode) {
            const errorMessages = {
                'auth/invalid-email': 'Adresse email invalide',
                'auth/user-disabled': 'Ce compte a été désactivé',
                'auth/user-not-found': 'Aucun compte trouvé avec cet email',
                'auth/wrong-password': 'Mot de passe incorrect',
                'auth/email-already-in-use': 'Un compte existe déjà avec cet email',
                'auth/weak-password': 'Le mot de passe est trop faible',
                'auth/network-request-failed': 'Erreur de réseau. Vérifiez votre connexion'
            };
            
            return errorMessages[errorCode] || 'Une erreur est survenue. Veuillez réessayer.';
        }
    </script>
</body>
</html>
